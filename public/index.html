<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SaeRo AI Editor</title>

    <script src="https://unpkg.com/docx@8.5.0/build/index.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.0/FileSaver.min.js"></script>

    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <script src="https://apis.google.com/js/api.js" async defer></script>
    <style>
    /* ================================================================== */
    /* == 기본 및 전체 레이아웃 (기존과 동일) == */
    /* ================================================================== */
    :root {
        --primary-color: #007bff;
        --secondary-color: #5a6268;
        --danger-color: #dc3545;
        --warning-color: #ffc107;
        --border-color: #dee2e6;
        --background-color: #f8f9fa;
        --section-background: #ffffff;
        --text-color: #212529;
        --text-secondary-color: #495057;
        --font-family-main: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
    }

    html { box-sizing: border-box; }
    *, *:before, *:after { box-sizing: inherit; }
    html, body {
        margin: 0; padding: 0; height: 100%;
        font-family: var(--font-family-main);
        background-color: var(--background-color);
        color: var(--text-color);
        overflow: hidden;
    }
    .main-container {
        display: flex;
        flex-direction: column;
        height: 100vh;
    }
    .Section1 {
        height: 45px;
        background-color: var(--section-background);
        border-bottom: 1px solid var(--border-color);
        padding: 0 20px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        flex-shrink: 0;
    }
    .brand-logo { font-weight: bold; color: #c62828; font-size: 1.2em; }
    .brand-highlight { color: black; }
    .user-info { font-size: 0.9em; color: var(--text-secondary-color); display: flex; align-items: center; }

    /* ▼▼▼ [추가] 로그인/로그아웃 버튼 스타일 ▼▼▼ */
    #google-sign-in-button, #google-sign-out-button {
        margin-left: 15px;
        padding: 6px 12px;
        border-radius: 6px;
        border: 1px solid #ccc;
        background-color: #f8f9fa;
        cursor: pointer;
        font-size: 12px;
        font-weight: 500;
        transition: background-color 0.2s;
    }
    #google-sign-in-button:hover, #google-sign-out-button:hover {
        background-color: #e9ecef;
    }
    #google-sign-out-button {
        border-color: var(--danger-color);
        background-color: #fbebee;
        color: var(--danger-color);
    }
    #google-sign-out-button:hover {
        background-color: #f8d7da;
    }
    /* ▲▲▲ [추가] 로그인/로그아웃 버튼 스타일 ▲▲▲ */
    
    .content-container {
        flex-grow: 1;
        display: flex;
        padding: 12px;
        gap: 12px;
        overflow: hidden;
    }
    .content-column {
        flex: 1;
        display: flex;
        flex-direction: column;
        min-width: 0;
        background-color: var(--section-background);
        border: 1px solid var(--border-color);
        border-radius: 8px;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
    }
    
    /* ... (탭, 편집기, AI 채팅, 팝업 등 나머지 CSS는 기존과 동일) ... */
    /* ================================================================== */
    /* == 탭 시스템 스타일 (Redesigned by Gemini v3.2 Final) == */
    /* ================================================================== */
    .tab-content-area {
        flex: 1;
        margin-top: 10px;
        display: flex;
        padding: 0 10px 10px 10px;
        overflow: hidden;
    }
    .tab-content-pane { display: none; }
    .tab-content-pane.active {
        display: flex; /* flex로 변경하여 내부 .container가 높이를 100% 채우도록 함 */
        flex-direction: column;
        flex: 1;
        overflow-y: auto;
    }
    .tab-bar {
        height: 40px;
        background-color: transparent;
        display: flex;
        flex-shrink: 0;
        border-bottom: 1px solid var(--border-color); 
        padding: 0 10px;
    }
    .tab-list { 
        display: flex; 
        flex: 1; 
        overflow: hidden;
        white-space: nowrap; 
        align-items: center;
    }
    .tab-list::-webkit-scrollbar { display: none; }
    .tab-list { -ms-overflow-style: none; scrollbar-width: none; }

    .tab { 
        padding: 8px 12px; 
        cursor: pointer; 
        background-color: transparent; 
        border: 1px solid var(--border-color);
        color: var(--text-secondary-color);
        transition: all 0.2s ease-in-out;
        flex-shrink: 0;
        border-radius: 6px; 
        margin-right: 5px;
        border-bottom-left-radius: 0; /* 아래쪽 모서리 각 제거 */
        border-bottom-right-radius: 0;
    }
    .tab:hover { 
        background-color: #e9ecef;
        color: var(--text-color); 
    }
    .tab.active { 
        background-color: #007bff; /* 진한 회색 배경 */
        color: white;              /* 흰색 글자 */
        font-weight: 600;          /* 굵은 글씨체 */
        border-color: #007bff;    /* 테두리도 같은 색으로 통일 */
    }

    .tab-nav-start, /* 쉼표를 이용해 새 클래스 추가 */
    .tab-controls { 
        display: flex; 
        align-items: center; /* 자식 요소를 세로 중앙 정렬 */
        margin-right: 4px;
    }
    
    .tab-nav-button { 
        padding: 0 10px; height: 28px; display: flex; align-items: center; justify-content: center; 
        background-color: #fff; border: 1px solid var(--border-color); cursor: pointer; 
        font-size: 1.1em; color: var(--text-secondary-color); border-radius: 6px; margin-left: 5px;
    }
    .tab-nav-button:hover { background-color: #e9ecef; }
    .close-tab { margin-left: 8px; font-size: 14px; line-height: 1; padding: 2px; border-radius: 50%; }
    .close-tab:hover { background-color: #dee2e6; }
    .tab-edit-input { border: 1px solid var(--primary-color); outline: none; padding: 1px 3px; width: 80px; font-family: inherit; font-size: inherit; border-radius: 3px; }

    /* ================================================================== */
    /* == 편집기 내부 스타일 (Redesigned by Gemini v3.2 Final) == */
    /* ================================================================== */
    .container {
        width: 100%; height: 100%; display: flex; flex-direction: column; gap: 10px;
    }
    .section {
        background-color: #f8f9fa;
        padding: 12px;
        border: 1px solid #e9ecef;
        border-radius: 8px;
        flex-shrink: 0;
    }
    
    .form-group { display: flex; align-items: center; width: auto; }
    .form-group label { margin-right: 8px; color: var(--text-secondary-color); flex-shrink: 0; font-size: 12px; }
    .form-group input, .form-group select {
        padding: 6px 8px; border: 1px solid var(--border-color); border-radius: 6px; 
        font-size: 12px; transition: border-color 0.2s, box-shadow 0.2s;
    }
    .form-group input:focus, .form-group select:focus {
        outline: none;
        border-color: var(--primary-color);
        box-shadow: 0 0 0 3px rgba(0, 123, 255, 0.15);
    }
    #docTitle { flex-grow: 1; }

    .global-settings-grid, .syntax-buttons-wrapper {
        display: flex;
        flex-wrap: nowrap;
        overflow-x: auto;
        padding-bottom: 10px;
    }
    .global-settings-grid {
        gap: 30px; /* 설정 항목 사이의 간격을 16px로 늘립니다 */
        align-items: center;
    }
    .syntax-buttons-wrapper {
        gap: 4px; /* 버튼 사이 간격은 4px로 유지 */
    }   

    .global-settings-grid .form-group input,
    .global-settings-grid .form-group select {
        width: 80px; /* 모든 입력창의 너비를 90px로 고정 */
    }

    .syntax-buttons-wrapper button { 
        height: 30px; 
        width: 100px;  /* 가로 크기 100px로 고정 */
        padding: 0 10px; /* 내부 여백 조정 */
        font-size: 11px; 
        color: white; 
        border: none; 
        border-radius: 4px; 
        cursor: pointer; 
        transition: filter 0.2s;
        display: flex;
        align-items: center;
        justify-content: space-between;
    }
    
    .syntax-buttons-wrapper .button-text {
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        text-align: left;
        flex-grow: 1;
    }
    .syntax-buttons-wrapper small {
        margin-left: 6px;
        flex-shrink: 0; /* 단축키가 줄어들지 않도록 설정 */
    }
    
    .syntax-buttons-wrapper button:hover { filter: brightness(1.15); }
    .syntax-buttons-wrapper button.group1 { background-color: #0056b3; }
    .syntax-buttons-wrapper button.group2 { background-color: #138496; }
    .syntax-buttons-wrapper button.group3 { background-color: #1e7e34; }
    .syntax-buttons-wrapper button.group4 { background-color: #d39e00; color: white; }
    .syntax-buttons-wrapper button.group5 { background-color: #563d7c; }

    .simple-find-replace-bar { display: flex; flex-direction: column; gap: 8px; }
    .find-replace-inputs { display: flex; gap: 10px; width: 100%; align-items: center; }
    .find-replace-inputs label { display: flex; align-items: center; gap: 5px; font-size: 12px; }
    .find-replace-inputs input { width: 200px }
    .find-replace-buttons { display: flex; flex-wrap: wrap; gap: 6px; }
    .syntax-button-like { background-color: #fff; border: 1px solid var(--border-color); border-radius: 6px; font-size: 11.5px; padding: 4px 8px; cursor: pointer; transition: background-color 0.2s; }
    .syntax-button-like:hover { background-color: #f1f3f5; }

    #mainTextArea, #memoTextArea { 
        width: 100%; height: 100%; border: 1px solid var(--border-color); 
        resize: none;
        font-family: var(--font-family-main); /* 글꼴을 다른 UI와 동일하게 지정 */
        font-size: 12px; /* "찾기:"와 같은 크기로 수정 */
        line-height: 1.6; padding: 12px;
        border-radius: 8px;
    }
    
    #mainTextArea:focus, #memoTextArea:focus {
        outline: none; border-color: var(--primary-color);
        box-shadow: 0 0 0 3px rgba(0, 123, 255, 0.15);
    }
    /* ▼▼▼ [수정] 텍스트 입력창을 감싸는 컨테이너 스타일 복원 ▼▼▼ */
    .main-editor-area { flex-grow: 1; display: flex; flex-direction: column; }
    .section[style*="min-height"] { flex-grow: 1; display: flex; flex-direction: column; }
    
    .action-buttons { 
        display: flex; justify-content: flex-end; gap: 8px; 
        margin-top: auto;
        padding-top: 6px;
        flex-wrap: nowrap;
        flex-shrink: 0;
    } 
    .action-buttons button { 
        padding: 8px 16px; border: none; border-radius: 6px; cursor: pointer; 
        font-weight: 600; font-size: 13px; transition: all 0.2s ease-in-out; white-space: nowrap;
    }
    .action-buttons button:hover { transform: translateY(-2px); box-shadow: 0 4px 8px rgba(0,0,0,0.1); }
    .action-buttons .open-drive { background-color: var(--primary-color); color: white; }
    .action-buttons .load-file { background-color: var(--secondary-color); color: white; } 
    .action-buttons .save-draft { background-color: var(--warning-color); color: black; }
    .action-buttons .create-doc { background-color: #28a745; color: white; }
    .action-buttons .delete-all { background-color: var(--danger-color); color: white; }

    .Section3 {
        height: 30px;
        background-color: var(--background-color);
        border-top: 1px solid var(--border-color);
        padding: 0 20px;
        font-size: 11px;
        color: var(--text-secondary-color);
        display: flex;
        align-items: center;
        flex-shrink: 0;
    }

/* ================================================================== */
/* == AI 채팅 UI 스타일 (v2 - Gemini Layout) == */
/* ================================================================== */
.chat-container {
    width: 100%; height: 100%; display: flex; flex-direction: column;
    overflow: hidden; background-color: #fff;
}
.chat-messages {
    flex-grow: 1; overflow-y: auto; padding: 4px 4px;
    display: flex; flex-direction: column; gap: 15px;
}
.message {
    display: flex; max-width: 85%; align-self: flex-start;
}
.message-user {
    align-self: flex-end;
}
.message-content {
    padding: 12px 18px; border-radius: 18px; background-color: #f1f3f5;
    color: var(--text-color); line-height: 1.6; white-space: pre-wrap;
    font-family: var(--font-family-main); font-size: 13px;
}
.message-user .message-content {
    background-color: var(--primary-color); color: white;
}

.message-wrapper {
    display: flex;
    align-items: flex-start; /* 버튼과 말풍선 상단 정렬 */
    gap: 8px;
}

/* 수정 후 코드 */
.copy-btn {
    flex-shrink: 0;
    border: none; /* 테두리 제거 */
    background-color: transparent; /* 배경 투명하게 */
    color: var(--text-secondary-color);
    border-radius: 6px;
    width: 32px;
    height: 32px;
    cursor: pointer;
    font-size: 16px;
    margin-top: 5px;
    transition: background-color 0.2s, color 0.2s; /* 색상 변경 애니메이션 추가 */
    opacity: 0.5; /* 평소에는 반투명하게 */
}
.copy-btn:hover {
    background-color: #e9ecef;
    color: var(--text-color); /* 마우스 올리면 진하게 */
    opacity: 1; /* 마우스 올리면 불투명하게 */
}
/* 사용자 말풍선 쪽 복사 버튼은 왼쪽으로 이동 */
.message-user .message-wrapper {
    flex-direction: row-reverse; /* 내용과 버튼 순서 뒤집기 */
}
    
/* --- ▼▼▼ 핵심 수정 영역 ▼▼▼ --- */

.chat-input-section {
    padding: 4px;
    border-top: 1px solid var(--border-color);
    background-color: #fff;
    flex-shrink: 0;
    margin-top: 1px;
}

/* 첨부파일 스크롤 컨테이너 */
.file-preview-container-wrapper {
    overflow-x: auto; /* 내용이 넘치면 가로 스크롤 생성 */
    padding-bottom: 8px; /* 스크롤바와 입력창 사이 간격 */
}
/* 스크롤바 숨기기 (선택 사항) */
.file-preview-container-wrapper::-webkit-scrollbar {
    height: 5px;
}
.file-preview-container-wrapper::-webkit-scrollbar-thumb {
    background: #ccc; border-radius: 5px;
}

/* 실제 첨부파일 아이템들을 담는 곳 */
.file-preview-container {
    display: flex; /* 가로로 배열 */
    flex-wrap: nowrap; /* 줄바꿈 없음 */
    gap: 8px;
    padding-top: 2px; /* 위쪽 여백 */
    min-height: 20px; /* 파일이 없을 때도 최소 높이 유지 */
}

.file-preview-item {
    display: flex; align-items: center; gap: 6px;
    background: #e9ecef; padding: 4px 10px; border-radius: 16px; /* 둥근 알약 형태 */
    font-size: 12px;
    flex-shrink: 0; /* 크기 줄어들지 않음 */
    white-space: nowrap; /* 파일 이름 줄바꿈 방지 */
}
.file-preview-item .remove-file-btn {
    cursor: pointer; font-size: 16px; line-height: 1; padding: 0 2px;
    margin-left: 4px;
}

/* 입력창 전체를 감싸는 래퍼 */
.chat-input-wrapper {
    display: flex;
    flex-direction: column; /* 세로로 배열 (입력창과 버튼 그룹) */
    gap: 8px;
    padding: 10px; border: 1px solid #ccc;
    border-radius: 12px; background-color: #f8f9fa;
    transition: box-shadow 0.2s;
}
.chat-input-wrapper:focus-within {
    border-color: var(--primary-color);
    box-shadow: 0 0 0 2px rgba(0, 123, 255, 0.15);
}

/* 텍스트 입력창 */
.message-input {
    width: 100%; /* 너비 100% */
    border: none; outline: none; padding: 4px 0;
    font-size: 14px; background-color: transparent; resize: none;
    max-height: 150px; overflow-y: auto; line-height: 1.5;
}

/* 버튼들을 감싸는 그룹 */
.chat-button-group {
    display: flex;
    justify-content: flex-end; /* 버튼들을 왼쪽부터 정렬 */
    gap: 8px;
    width: 100%;
}

/* File, 보내기 버튼 공통 스타일 */
.chat-tool-btn {
    border-radius: 8px; border: 1px solid #ccc;
    background-color: #fff; cursor: pointer;
    font-size: 13px; font-weight: 500;
    display: flex; align-items: center; justify-content: center;
    transition: background-color 0.2s;
    padding: 6px 14px;
}
.chat-tool-btn:hover {
    background-color: #e9ecef;
}

/* 보내기 버튼 전용 스타일 */
.chat-tool-btn.send-btn {
    width: 40px; /* 정사각형에 가깝게 */
    height: 32px;
    padding: 0;
    border-radius: 8px; /* 동그란 버튼에서 사각형으로 변경 */
    background-color: var(--primary-color);
    color: white;
    font-size: 1.2em;
}
.chat-tool-btn.send-btn:hover {
    filter: brightness(1.1);
}

/* ================================================================== */
/* == 팝업 및 로딩 창 스타일 (최상위 z-index 적용) == */
/* ================================================================== */
.loading-popup,
.custom-alert-popup {
    position: fixed; /* 화면 전체를 기준으로 위치 */
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0, 0, 0, 0.4); /* 반투명 배경 */
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 10000; /* 다른 모든 요소들보다 위에 있도록 높은 값 설정 */
    padding: 20px;
    box-sizing: border-box;
}

.loading-popup-content,
.custom-alert-content {
    background-color: white;
    padding: 25px 35px;
    border-radius: 12px;
    box-shadow: 0 5px 20px rgba(0, 0, 0, 0.2);
    text-align: center;
    max-width: 400px;
    width: 100%;
}

.custom-alert-content p,
.loading-popup-content p {
    margin: 0 0 20px 0;
    font-size: 16px;
    color: var(--text-color);
}

.custom-alert-content .button-group {
    display: flex;
    gap: 10px;
    justify-content: center;
}

.custom-alert-content button,
.loading-popup-content button {
    padding: 8px 20px;
    border: 1px solid #ccc;
    border-radius: 6px;
    cursor: pointer;
    background-color: #f8f9fa;
    font-size: 14px;
    font-weight: 500;
    min-width: 80px;
}
.custom-alert-content button:hover,
.loading-popup-content button:hover {
    background-color: #e9ecef;
}

/* 확인, 취소 버튼 등 특정 버튼에 대한 스타일 */
.custom-alert-content #customConfirmOkButton,
.custom-alert-content #customAlertOkButton {
    background-color: var(--primary-color);
    color: white;
    border-color: var(--primary-color);
}
.custom-alert-content #customConfirmOkButton:hover,
.custom-alert-content #customAlertOkButton:hover {
    filter: brightness(1.1);
}

/* 로딩바 스타일 */
.progress-bar-container {
    height: 8px;
    width: 100%;
    background-color: #e9ecef;
    border-radius: 4px;
    overflow: hidden;
    margin-top: 10px;
}
.progress-bar-animated {
    width: 100%;
    height: 100%;
    background-color: var(--primary-color);
    border-radius: 4px;
    background-image: linear-gradient(45deg, rgba(255, 255, 255, .15) 25%, transparent 25%, transparent 50%, rgba(255, 255, 255, .15) 50%, rgba(255, 255, 255, .15) 75%, transparent 75%, transparent);
    background-size: 40px 40px;
    animation: progress-bar-stripes 1s linear infinite;
}

@keyframes progress-bar-stripes {
    from { background-position: 40px 0; }
    to { background-position: 0 0; }
}
    
</style>
    
</head>
<body>
    <div class="main-container">
        <div class="Section1">
            <span class="brand-logo">SaeRo <span class="brand-highlight">AI Editor</span></span>
            <span class="user-info">
                [<span id="user-name">Guest</span>, <span id="user-email">Not logged in</span>]
                <button id="google-sign-in-button" disabled>Google 로그인</button>
                <button id="google-sign-out-button" style="display: none;">로그아웃</button>
            </span>
             </div>

        <div class="content-container">
            <div class="content-column Section2-1"></div>
            <div class="content-column Section2-2"></div>
            <div class="content-column Section2-3"></div>
        </div>

        <div class="Section3">
            <p>&copy; 2025 법률사무소 새로 박예준. All Rights Reserved.</p>
        </div>
    </div>
  <div id="loadingPopup" class="loading-popup" style="display: none;"> 
    <div class="loading-popup-content"> <p>작업 진행 중... <span id="loadingTimeElapsed">[0.00 Sec]</span></p> <div class="progress-bar-container"><div class="progress-bar-animated"></div></div></div> 
  </div>
  <div id="customConfirm" class="custom-alert-popup" style="display: none;">
    <div class="custom-alert-content"> <p id="customConfirmMessage"></p> <div class="button-group"><button id="customConfirmOkButton">확인</button><button id="customConfirmCancelButton">취소</button></div></div>
  </div>
  <div id="customAlert" class="custom-alert-popup" style="display: none;">
    <div class="custom-alert-content"> <p id="customAlertMessage"></p> <button id="customAlertOkButton">확인</button></div>
  </div>

    

<script>
// ==================================================================
// SECTION 0: 전역 변수 및 상수 선언 (대규모 수정)
// ==================================================================

// --- Google API 관련 상수 ---
// 💡 중요: YOUR_GOOGLE_CLOUD_CLIENT_ID를 실제 값으로 교체하세요!
const CLIENT_ID = '983424591109-l4r2v7jnvmnrr8h1mm1j688k0h87spv4.apps.googleusercontent.com';
const SCOPES = 'https://www.googleapis.com/auth/drive.appdata https://www.googleapis.com/auth/userinfo.profile https://www.googleapis.com/auth/userinfo.email';
const SESSION_DATA_FILE_NAME = 'saero_ai_editor_session_v1.json'; // 세션 데이터를 저장할 파일 이름

// --- Google API 상태 변수 ---
let gapiInited = false;
let gisInited = false;
let tokenClient;
let googleUser = { isSignedIn: () => false }; // 로그인된 사용자 정보 저장 객체

// --- 애플리케이션 상태 변수 ---
let currentSessionData = {}; // 모든 탭의 상태를 저장하는 중앙 객체
let undoStack = {}; // 탭별 실행 취소 스택 (객체로 변경)
let mainTextArea, memoTextArea, docTitleInput, fontFamilySelect, fontSizeInput, lineSpacingInput, paraSpacingAfterInput, loadingPopup, marginTopInput, marginBottomInput, marginLeftInput, marginRightInput;

// --- 타이머 및 로딩 관련 변수 ---
const AUTO_SAVE_INTERVAL = 15 * 1000; // 15초
let autoSaveTimerIntervalId = null;
let loadingTimerIntervalId = null;
let loadingStartTime = 0;


// ==================================================================
// SECTION 1: HTML 콘텐츠 생성 함수 (기존과 동일)
// ==================================================================

function getPrompterListHtml() {
    return `<ul><li>프롬프터 항목 1</li><li>프롬프터 항목 2</li><li>프롬프터 항목 3</li></ul>`;
}

function getEditorHtml() {
    return `
      <div class="container">
        <div class="section">
          <div class="form-group"> 
            <label for="docTitle">문서제목:</label>
            <input type="text" id="docTitle" placeholder="입력하지 않으면 날짜/시간으로 자동 생성">
          </div>
        </div>
        <div class="section">
          <div class="global-settings-grid">
            <div class="form-group"> <label for="fontFamily">글꼴:</label> <select id="fontFamily"> <option value="Noto Sans KR">Noto Sans KR</option> <option value="Malgun Gothic">맑은 고딕</option> <option value="Arial">Arial</option> <option value="Times New Roman">Times New Roman</option> <option value="Calibri">Calibri</option> <option value="Batang" selected>바탕</option> <option value="Dotum">돋움</option> </select> </div>
            <div class="form-group"> <label for="fontSize">크기(pt):</label> <input type="number" id="fontSize" value="12" min="8"> </div>
            <div class="form-group"> <label for="lineSpacing">줄간격:</label> <input type="number" id="lineSpacing" value="1.5" step="0.1" min="1"> </div>
            <div class="form-group"> <label for="paraSpacingAfter">문단뒤(pt):</label> <input type="number" id="paraSpacingAfter" value="10" min="0"> </div>
            <div class="form-group"> <label for="pageOrientation">용지방향:</label> <select id="pageOrientation"> <option value="PORTRAIT" selected>세로</option> <option value="LANDSCAPE">가로</option></select></div> 
            <div class="form-group"> <label for="marginTop">여백-위(cm):</label> <input type="number" id="marginTop" value="2.0" step="0.1" min="0"> </div>
            <div class="form-group"> <label for="marginBottom">여백-아래(cm):</label> <input type="number" id="marginBottom" value="2.0" step="0.1" min="0"> </div>
            <div class="form-group"> <label for="marginLeft">여백-좌(cm):</label> <input type="number" id="marginLeft" value="2.5" step="0.1" min="0"> </div>
            <div class="form-group"> <label for="marginRight">여백-우(cm):</label> <input type="number" id="marginRight" value="2.5" step="0.1" min="0"> </div>
          </div>
        </div>
        <div class="section">
            <div class="syntax-buttons-wrapper">
                <button class="group1" onclick="insertSyntax('{제목1.1}')" title="{제목1.1}"><span class="button-text">{제목1.1}</span><small>[Alt+1]</small></button>
                <button class="group1" onclick="insertSyntax('{제목1.2}')" title="{제목1.2}"><span class="button-text">{제목1.2}</span><small>[Alt+2]</small></button>
                <button class="group1" onclick="insertSyntax('{제목1.3}')" title="{제목1.3}"><span class="button-text">{제목1.3}</span><small>[Alt+3]</small></button>
                <button class="group1" onclick="insertSyntax('{제목2.1}')" title="{제목2.1}"><span class="button-text">{제목2.1}</span><small>[Alt+4]</small></button>
                <button class="group1" onclick="insertSyntax('{제목2.2}')" title="{제목2.2}"><span class="button-text">{제목2.2}</span><small>[Alt+5]</small></button>
                <button class="group1" onclick="insertSyntax('{제목2.3}')" title="{제목2.3}"><span class="button-text">{제목2.3}</span><small>[Alt+6]</small></button>
                <button class="group1" onclick="insertSyntax('{제목3.1}')" title="{제목3.1}"><span class="button-text">{제목3.1}</span><small>[Alt+7]</small></button>
                <button class="group1" onclick="insertSyntax('{제목3.2}')" title="{제목3.2}"><span class="button-text">{제목3.2}</span><small>[Alt+8]</small></button>
                <button class="group1" onclick="insertSyntax('{제목3.3}')" title="{제목3.3}"><span class="button-text">{제목3.3}</span><small>[Alt+9]</small></button>
                <button class="group2" onclick="insertSyntax('{왼쪽}')" title="{왼쪽}"><span class="button-text">{왼쪽}</span><small>[Alt+Q]</small></button>
                <button class="group2" onclick="insertSyntax('{가운데}')" title="{가운데}"><span class="button-text">{가운데}</span><small>[Alt+W]</small></button>
                <button class="group2" onclick="insertSyntax('{오른쪽}')" title="{오른쪽}"><span class="button-text">{오른쪽}</span><small>[Alt+E]</small></button>
                <button class="group2" onclick="insertSyntax('{양쪽}')" title="{양쪽}"><span class="button-text">{양쪽}</span><small>[Alt+R]</small></button>
                <button class="group2" onclick="insertSyntax('{균등}')" title="{균등}"><span class="button-text">{균등}</span><small>[Alt+T]</small></button>
                <button class="group2" onclick="insertSyntax('{10pt}')" title="{10pt}"><span class="button-text">{10pt}</span><small>[Alt+Y]</small></button>
                <button class="group2" onclick="insertSyntax('{1줄}')" title="{1줄}"><span class="button-text">{1줄}</span><small>[Alt+U]</small></button>
                <button class="group2" onclick="insertSyntax('{들여쓰기,1번줄:0.5,2번줄이하:0.5}')" title="{들여쓰기,1번줄:0.5,2번줄이하:0.5}"><span class="button-text">{들여쓰기...}</span><small>[Alt+I]</small></button>
                <button class="group2" onclick="insertSyntax('{들여쓰기,1번줄:1,2번줄이하:1}')" title="{들여쓰기,1번줄:1,2번줄이하:1}"><span class="button-text">{들여쓰기...}</span><small>[Alt+O]</small></button>
                <button class="group2" onclick="insertSyntax('{들여쓰기,1번줄:0,2번줄이하:0.5}')" title="{들여쓰기,1번줄:0,2번줄이하:0.5}"><span class="button-text">{들여쓰기...}</span><small>[Alt+P]</small></button>
                <button class="group2" onclick="insertSyntax('{들여쓰기,1번줄:0.5,2번줄이하:1}')" title="{들여쓰기,1번줄:0.5,2번줄이하:1}"><span class="button-text">{들여쓰기...}</span><small>[Alt+[ ]</small></button>
                <button class="group3" onclick="insertSyntax('{진하게}')" title="{진하게}"><span class="button-text">{진하게}</span><small>[Alt+A]</small></button>
                <button class="group3" onclick="insertSyntax('{밑줄}')" title="{밑줄}"><span class="button-text">{밑줄}</span><small>[Alt+S]</small></button>
                <button class="group3" onclick="insertSyntax('{>>}')" title="{>>}"><span class="button-text">{>>}</span><small>[Alt+D]</small></button>
                <button class="group3" onclick="insertSyntax('{<<}')" title="{<<}"><span class="button-text">{<<}</span><small>[Alt+F]</small></button>
                <button class="group3" onclick="insertSyntax('{탭}')" title="{탭}"><span class="button-text">{탭}</span><small>[Alt+G]</small></button>
                <button class="group3" onclick="insertSyntax('{줄바꿈}')" title="{줄바꿈}"><span class="button-text">{줄바꿈}</span><small>[Alt+H]</small></button>
                <button class="group3" onclick="insertSyntax('{문단바꿈}')" title="{문단바꿈}"><span class="button-text">{문단바꿈}</span><small>[Alt+J]</small></button>
                <button class="group3" onclick="insertSyntax('{페이지바꿈}')" title="{페이지바꿈}"><span class="button-text">{페이지바꿈}</span><small>[Alt+K]</small></button>
                <button class="group4" onclick="insertSyntax('{표시작1,글꼴=??,크기=#}')" title="{표시작1,글꼴=??,크기=#}"><span class="button-text">{표시작1...}</span><small>[Alt+Z]</small></button>
                <button class="group4" onclick="insertSyntax('{표시작1,테두리없음}')" title="{표시작1,테두리없음}"><span class="button-text">{표시작1,테두리없음}</span><small>[Alt+X]</small></button>
                <button class="group4" onclick="insertSyntax('{표끝1}')" title="{표끝1}"><span class="button-text">{표끝1}</span><small>[Alt+C]</small></button>
                <button class="group4" onclick="insertSyntax('{표시작2,글꼴=??,크기=#}')" title="{표시작2,글꼴=??,크기=#}"><span class="button-text">{표시작2...}</span><small>[Alt+V]</small></button>
                <button class="group4" onclick="insertSyntax('{표끝2}')" title="{표끝2}"><span class="button-text">{표끝2}</span><small>[Alt+B]</small></button>
                <button class="group4" onclick="insertSyntax('{제목행}')" title="{제목행}"><span class="button-text">{제목행}</span><small>[Alt+N]</small></button>
                <button class="group4" onclick="insertSyntax('{회색}')" title="{회색}"><span class="button-text">{회색}</span><small>[Alt+M]</small></button>
                <button class="group4" onclick="insertSyntax('{남색}')" title="{남색}"><span class="button-text">{남색}</span><small>[Alt+,]</small></button>
                <button class="group5" onclick="insertSyntax('{그림:~}')" title="{그림:~}"><span class="button-text">{그림:~}</span><small>[Alt+.]</small></button>
            </div>
        </div>
        <div class="section simple-find-replace-bar">
          <div class="find-replace-inputs">
            <label>찾기: <input type="text" id="simpleFindText"></label>
            <label>바꾸기: <input type="text" id="simpleReplaceText"></label>
          </div>
          <div class="find-replace-buttons">
            <button class="syntax-button-like" onclick="simpleFindNext()">다음 찾기</button>
            <button class="syntax-button-like" onclick="simpleReplaceCurrent()">바꾸기</button>
            <button class="syntax-button-like" onclick="previewSelectionBeforeReplaceAll()">모두 바꾸기</button>
            <button class="syntax-button-like" onclick="performUndo()">되돌리기</button> 
            <button class="syntax-button-like" onclick="resetFindReplace()">초기화</button>
          </div>
        </div>
        <div class="section main-editor-area">
          <textarea id="mainTextArea" placeholder="여기는 문서로 작성할 내용을 입력하는 부분입니다."></textarea>
        </div>
        <div class="section" style="flex-shrink: 1; flex-grow: 0; min-height: 100px; display: flex; flex-direction: column; ">
          <textarea id="memoTextArea" placeholder="여기는 본문 작성시에 참고할 내용을 메모하는 부분입니다.&#10;문서로 작성되지 않습니다."></textarea>
        </div>
        <div class="action-buttons">
            <button class="open-drive" onclick="showCustomAlert('준비 중인 기능입니다.')">Google Drive</button>
            <button class="load-file" onclick="showCustomAlert('준비 중인 기능입니다.')">불러오기</button>
            <button class="save-draft" onclick="saveDraft()">저장<small style="font-weight: normal; margin-left: 3px;">[Ctrl+S]</small></button>
            <button class="create-doc" onclick="createWordClientSide()">문서작성</button>
            <button class="delete-all" onclick="clearActiveTabText()">현재탭삭제</button>
        </div>
      </div>
    `;
}

function getAiChatHtml() {
    return `
      <div class="chat-container">
        <div class="chat-messages">
          <div class="message message-assistant">
              <div class="message-content">안녕하세요! 무엇을 도와드릴까요? 파일을 업로드하거나, 아래 입력창에 질문을 입력해주세요.</div>
          </div>
        </div>
        <div class="chat-input-section">
          
          <div class="file-preview-container-wrapper">
            <div class="file-preview-container"></div>
          </div>

          <div class="chat-input-wrapper">
            <textarea class="message-input" placeholder="여기에 메시지 입력... (Shift+Enter로 줄바꿈)" rows="1"></textarea>
            <input type="file" class="file-input" multiple hidden accept="*/*">
            
            <div class="chat-button-group">
                <button class="chat-tool-btn upload-btn" title="파일 업로드">File</button>
                <button class="chat-tool-btn send-btn" title="보내기">➤</button>
            </div>
          </div>

        </div>
      </div>
    `;
}
    
// ==================================================================
// SECTION 2: UI 피드백 및 유틸리티 함수 (일부 수정)
// ==================================================================

// --- UI 피드백 함수 (팝업, 로딩) ---
function showLoadingPopup() { if (!loadingPopup) return; loadingPopup.style.display = 'flex'; loadingStartTime = Date.now(); const timeDisplay = document.getElementById('loadingTimeElapsed'); if (timeDisplay) timeDisplay.textContent = '[0.00 Sec]'; if (loadingTimerIntervalId) clearInterval(loadingTimerIntervalId); loadingTimerIntervalId = setInterval(() => { const elapsedTimeMs = Date.now() - loadingStartTime; if (timeDisplay) timeDisplay.textContent = `[${(elapsedTimeMs / 1000).toFixed(2)} Sec]`; }, 100); }
function hideLoadingPopup() { if (!loadingPopup) return; loadingPopup.style.display = 'none'; if (loadingTimerIntervalId) { clearInterval(loadingTimerIntervalId); loadingTimerIntervalId = null; } }
function showCustomAlert(message) { const popup = document.getElementById('customAlert'); const messageEl = document.getElementById('customAlertMessage'); const okButton = document.getElementById('customAlertOkButton'); if (!popup || !messageEl || !okButton) return; messageEl.textContent = message; popup.style.display = 'flex'; okButton.onclick = () => popup.style.display = 'none'; }
function showCustomConfirm(message) { const popup = document.getElementById('customConfirm'); const messageEl = document.getElementById('customConfirmMessage'); const okButton = document.getElementById('customConfirmOkButton'); const cancelButton = document.getElementById('customConfirmCancelButton'); if (!popup || !messageEl || !okButton || !cancelButton) return Promise.reject(); return new Promise((resolve, reject) => { messageEl.textContent = message; popup.style.display = 'flex'; okButton.onclick = () => { popup.style.display = 'none'; resolve(true); }; cancelButton.onclick = () => { popup.style.display = 'none'; reject(false); popup.style.display = 'none'; }; }); }

// --- [수정] 현재 활성화된 에디터 탭 내용 삭제 ---
async function clearActiveTabText() {
    if (!mainTextArea) return;
    try {
        await showCustomConfirm('현재 에디터 탭의 문서 제목, 내용, 메모를 전체 삭제하시겠습니까?');
        mainTextArea.value = '';
        memoTextArea.value = '';
        docTitleInput.value = '';
        
        // [수정] 변경 사항을 즉시 currentSessionData에 반영하고 저장합니다.
        await updateAndSaveSession();
        showCustomAlert('현재 탭의 내용이 모두 삭제되었습니다.');
    } catch (error) {
        console.log('삭제 취소');
    }
}

// --- 유틸리티 및 보조 함수 (기존과 동일) ---
function generateFilename(prefix) { const now = new Date(); const yymmdd = now.getFullYear().toString().slice(-2) + (now.getMonth() + 1).toString().padStart(2, '0') + now.getDate().toString().padStart(2, '0'); const hhmmss = now.getHours().toString().padStart(2, '0') + now.getMinutes().toString().padStart(2, '0') + now.getSeconds().toString().padStart(2, '0'); return `${prefix}제목없음_${yymmdd}_T${hhmmss}`; }
function insertSyntax(syntax) { if (!mainTextArea) return; const { scrollTop, selectionStart, selectionEnd, value } = mainTextArea; mainTextArea.value = value.substring(0, selectionStart) + syntax + value.substring(selectionEnd); mainTextArea.focus(); mainTextArea.selectionStart = mainTextArea.selectionEnd = selectionStart + syntax.length; mainTextArea.scrollTop = scrollTop; }
function handleContextScroll(isScrollingDown) { if (!mainTextArea) return; const computedStyle = window.getComputedStyle(mainTextArea); const lineHeight = parseFloat(computedStyle.lineHeight); const scrollAmount = mainTextArea.clientHeight - (3 * lineHeight); let newScrollTop = isScrollingDown ? mainTextArea.scrollTop + scrollAmount : mainTextArea.scrollTop - scrollAmount; mainTextArea.scrollTo({ top: newScrollTop, behavior: 'smooth' }); }

// ==================================================================
// SECTION 3: Google 인증 및 데이터 관리 함수 (신규 및 수정)
// ==================================================================

// --- Google API 초기화 콜백 ---
function gapiLoaded() {
    gapi.load('client', () => {
        gapi.client.init({
            // apiKey는 OAuth 2.0에서는 사용되지 않습니다.
            discoveryDocs: ['https://www.googleapis.com/discovery/v1/apis/drive/v3/rest', 'https://www.googleapis.com/discovery/v1/apis/people/v1/rest'],
        }).then(() => {
            gapiInited = true;
            maybeEnableButtons();
        }).catch(e => console.error("GAPI 클라이언트 초기화 실패:", e));
    });
}

function gisLoaded() {
    tokenClient = google.accounts.oauth2.initTokenClient({
        client_id: CLIENT_ID,
        scope: SCOPES,
        callback: async (tokenResponse) => {
            if (tokenResponse && tokenResponse.access_token) {
                googleUser = { isSignedIn: () => true };
                await updateLoginUI(true);
                // 로그인 성공 시에만 Drive에서 데이터 로드
                await loadAndApplySessionData(true);
            } else {
                console.error("Access Token 획득 실패:", tokenResponse);
            }
        },
        error_callback: (error) => {
             console.error("Google 로그인 오류:", error);
             showCustomAlert(`Google 로그인 중 오류가 발생했습니다: ${error.error}`);
        }
    });
    gisInited = true;
    maybeEnableButtons();
}

function maybeEnableButtons() {
    if (gapiInited && gisInited) {
        document.getElementById('google-sign-in-button').disabled = false;
    }
}

// --- 로그인/로그아웃 및 UI 업데이트 ---
function handleAuthClick() {
    if (gapi.client.getToken() === null) {
        tokenClient.requestAccessToken({ prompt: 'consent' });
    }
}

async function handleSignoutClick() {
    await updateAndSaveSession(); // 로그아웃 전 마지막 상태 저장
    const token = gapi.client.getToken();
    if (token !== null) {
        google.accounts.oauth2.revoke(token.access_token, () => {
            gapi.client.setToken('');
            googleUser = { isSignedIn: () => false };
            updateLoginUI(false);
            showCustomAlert('로그아웃 되었습니다.');
        });
    }
}

async function updateLoginUI(isSignedIn) {
    const signInBtn = document.getElementById('google-sign-in-button');
    const signOutBtn = document.getElementById('google-sign-out-button');
    const userNameSpan = document.getElementById('user-name');
    const userEmailSpan = document.getElementById('user-email');

    if (isSignedIn) {
        signInBtn.style.display = 'none';
        signOutBtn.style.display = 'inline-block';
        try {
            const response = await gapi.client.people.people.get({
                resourceName: 'people/me',
                personFields: 'names,emailAddresses',
            });
            const profile = response.result;
            userNameSpan.textContent = profile.names && profile.names.length > 0 ? profile.names[0].displayName : 'Unknown';
            userEmailSpan.textContent = profile.emailAddresses && profile.emailAddresses.length > 0 ? profile.emailAddresses[0].value : 'No email';
        } catch (e) {
            console.error('사용자 프로필 정보 로드 실패:', e);
            userNameSpan.textContent = '로그인됨';
            userEmailSpan.textContent = '정보 없음';
        }
    } else {
        signInBtn.style.display = 'inline-block';
        signOutBtn.style.display = 'none';
        userNameSpan.textContent = 'Guest';
        userEmailSpan.textContent = 'Not logged in';
    }
}

// --- 데이터 저장/로드 로직 ---
async function updateAndSaveSession() {
    console.log("세션 상태 업데이트 및 저장 시작...");
    // 1. 현재 UI 상태를 currentSessionData 객체로 캡처
    captureCurrentState();
    
    // 2. LocalStorage에 임시 저장 (즉각적인 복원용)
    localStorage.setItem('saeroAiEditorSession', JSON.stringify(currentSessionData));
    console.log('세션 데이터 로컬 스토리지에 임시 저장 완료');

    // 3. Google Drive에 저장 (로그인 시에만)
    if (googleUser.isSignedIn()) {
        try {
            await saveSessionDataToDrive(currentSessionData);
            console.log("Google Drive에 세션 데이터 저장 완료.");
        } catch (e) {
            console.error('Google Drive 저장 실패:', e);
            showCustomAlert('Google Drive에 자동 저장하는 중 오류가 발생했습니다.');
        }
    }
}

function captureCurrentState() {
    // 각 탭 컴포넌트의 데이터를 순회하며 currentSessionData를 업데이트
    document.querySelectorAll('.content-column').forEach(column => {
        const panes = column.querySelectorAll('.tab-content-pane');
        panes.forEach(pane => {
            const tabId = pane.dataset.tabId;
            const tabName = column.querySelector(`.tab[data-tab-id="${tabId}"] span`)?.textContent || tabId;

            if (!currentSessionData[tabId]) {
                currentSessionData[tabId] = {};
            }
            currentSessionData[tabId].tabName = tabName;
            currentSessionData[tabId].componentType = column.classList[1]; // e.g., 'Section2-3'

            if (column.classList.contains('Section2-3')) { // Editor
                currentSessionData[tabId].docTitle = pane.querySelector('#docTitle')?.value;
                currentSessionData[tabId].content = pane.querySelector('#mainTextArea')?.value;
                currentSessionData[tabId].memoContent = pane.querySelector('#memoTextArea')?.value;
                currentSessionData[tabId].settings = {
                    fontFamily: pane.querySelector('#fontFamily')?.value,
                    fontSize: pane.querySelector('#fontSize')?.value,
                    lineSpacing: pane.querySelector('#lineSpacing')?.value,
                    paraSpacingAfter: pane.querySelector('#paraSpacingAfter')?.value,
                    pageOrientation: pane.querySelector('#pageOrientation')?.value,
                    marginTop: pane.querySelector('#marginTop')?.value,
                    marginBottom: pane.querySelector('#marginBottom')?.value,
                    marginLeft: pane.querySelector('#marginLeft')?.value,
                    marginRight: pane.querySelector('#marginRight')?.value,
                };
            } else if (column.classList.contains('Section2-2')) { // AI Chat
                const messages = [];
                pane.querySelectorAll('.chat-messages .message').forEach(msgEl => {
                    const sender = msgEl.classList.contains('message-user') ? 'user' : 'assistant';
                    const text = msgEl.querySelector('.message-content')?.innerText;
                    if (text) messages.push({ sender, text });
                });
                currentSessionData[tabId].messages = messages;
            }
        });
    });
}

async function saveSessionDataToDrive(data) {
    const jsonString = JSON.stringify(data);
    const blob = new Blob([jsonString], { type: 'application/json' });
    
    // 기존 파일 찾기
    const searchResponse = await gapi.client.drive.files.list({
        q: `name='${SESSION_DATA_FILE_NAME}'`,
        spaces: 'appDataFolder',
        fields: 'files(id)'
    });
    
    const fileId = searchResponse.result.files?.[0]?.id;
    const form = new FormData();

    if (fileId) { // 파일 업데이트
        form.append('metadata', new Blob([JSON.stringify({})], { type: 'application/json' }));
        form.append('file', blob);
        await gapi.client.request({
            path: `https://www.googleapis.com/upload/drive/v3/files/${fileId}?uploadType=multipart`,
            method: 'PATCH',
            body: form
        });
    } else { // 새 파일 생성
        const fileMetadata = { name: SESSION_DATA_FILE_NAME, parents: ['appDataFolder'] };
        form.append('metadata', new Blob([JSON.stringify(fileMetadata)], { type: 'application/json' }));
        form.append('file', blob);
        await gapi.client.request({
            path: 'https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart',
            method: 'POST',
            body: form,
        });
    }
}

async function loadAndApplySessionData(fromDrive = false) {
    showLoadingPopup();
    let loadedData = null;
    let source = "localStorage";

    if (fromDrive && googleUser.isSignedIn()) {
        try {
            const searchResponse = await gapi.client.drive.files.list({
                q: `name='${SESSION_DATA_FILE_NAME}'`,
                spaces: 'appDataFolder',
                fields: 'files(id)'
            });
            const fileId = searchResponse.result.files?.[0]?.id;
            if (fileId) {
                const contentResponse = await gapi.client.drive.files.get({ fileId, alt: 'media' });
                loadedData = contentResponse.result;
                source = "Google Drive";
                console.log('Google Drive에서 세션 데이터 로드 성공');
            }
        } catch (error) {
            console.error('Google Drive에서 세션 데이터 로드 실패:', error);
        }
    }

    if (!loadedData) {
        const localStorageData = localStorage.getItem('saeroAiEditorSession');
        if (localStorageData) {
            try {
                loadedData = JSON.parse(localStorageData);
                console.log('LocalStorage에서 세션 데이터 로드 성공');
            } catch (e) {
                console.error('LocalStorage 데이터 파싱 실패:', e);
            }
        }
    }

    if (loadedData && Object.keys(loadedData).length > 0) {
        currentSessionData = loadedData;
        showCustomAlert(`${source}에서 직전 작업 내용을 불러왔습니다.`);
    } else {
        // 기본 탭 데이터 생성
        currentSessionData = {
            'editor_tab1': { tabName: '문서1', componentType: 'Section2-3', docTitle: '', content: '', memoContent: '', settings: { fontFamily: '바탕', fontSize: '12', lineSpacing: '1.5', paraSpacingAfter: '10', pageOrientation: 'PORTRAIT', marginTop: '2.0', marginBottom: '2.0', marginLeft: '2.5', marginRight: '2.5' }},
            'chat_tab1': { tabName: '대화1', componentType: 'Section2-2', messages: [{ sender: 'assistant', text: '안녕하세요! 무엇을 도와드릴까요?' }] },
            'prompter_tab1': { tabName: '프롬프터1', componentType: 'Section2-1' }
        };
    }

    // UI 복원
    restoreUiFromSessionData();
    hideLoadingPopup();
    startAutoSaveTimer();
}

function restoreUiFromSessionData() {
    // 모든 컴포넌트 초기화
    document.querySelector('.Section2-1').innerHTML = '';
    document.querySelector('.Section2-2').innerHTML = '';
    document.querySelector('.Section2-3').innerHTML = '';
    
    // 컴포넌트 타입별 데이터 분리
    const prompterData = {};
    const chatData = {};
    const editorData = {};

    Object.keys(currentSessionData).forEach(tabId => {
        const data = currentSessionData[tabId];
        switch(data.componentType) {
            case 'Section2-1': prompterData[tabId] = data; break;
            case 'Section2-2': chatData[tabId] = data; break;
            case 'Section2-3': editorData[tabId] = data; break;
        }
    });

    initPrompterFeature(prompterData);
    initAiChatFeature(chatData);
    initEditorFeature(editorData);

    // 첫 번째 탭 활성화
    document.querySelector('.tab')?.click();
}


// --- 자동 저장 타이머 ---
function startAutoSaveTimer() {
    if (autoSaveIntervalId) clearInterval(autoSaveIntervalId);
    autoSaveIntervalId = setInterval(updateAndSaveSession, AUTO_SAVE_INTERVAL);
    console.log("자동 저장 타이머 시작 (15초 간격)");
}

function stopAutoSaveTimer() {
    clearInterval(autoSaveIntervalId);
    autoSaveTimerIntervalId = null;
    console.log("자동 저장 타이머 중지");
}

// --- 문서작성 (기존과 동일) ---
async function createWordClientSide() {
    // ... 기존 코드 유지 (docTitle, content, settings는 활성화된 탭에서 가져옴) ...
    if(!mainTextArea) {
        showCustomAlert("활성화된 에디터 탭이 없습니다.");
        return;
    }
    showLoadingPopup();
    const title = docTitleInput.value.trim();
    const content = mainTextArea.value;
    const settings = {
        font_family_east_asia: fontFamilySelect.value,
        font_size: parseFloat(fontSizeInput.value) || 12,
        line_spacing: parseFloat(lineSpacingInput.value) || 1.5,
        para_spacing_after: parseFloat(paraSpacingAfterInput.value) || 10,
        page_orientation: document.getElementById('pageOrientation').value,
        margin_top: parseFloat(marginTopInput.value) || 2.0,
        margin_bottom: parseFloat(marginBottomInput.value) || 2.0,
        margin_left: parseFloat(marginLeftInput.value) || 2.5,
        margin_right: parseFloat(marginRightInput.value) || 2.5,
    };
    try {
        const BACKEND_URL = "https://sraieditor20250711-983424591109.asia-northeast3.run.app";
        const response = await fetch(`${BACKEND_URL}/create-docx`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', },
            body: JSON.stringify({ content: content, settings: settings, title: title }),
        });
        hideLoadingPopup();
        if (response.ok) {
            const blob = await response.blob();
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.style.display = 'none';
            a.href = url;
            let fileName = title ? `${title}.docx` : 'generated_document.docx';
            a.download = fileName;
            document.body.appendChild(a);
            a.click();
            window.URL.revokeObjectURL(url);
            a.remove();
            showCustomAlert(`'${fileName}' 파일 다운로드가 시작됩니다.`);
        } else {
            const error = await response.json();
            showCustomAlert('파일 생성 중 오류 발생: ' + error.error);
        }
    } catch (error) {
        hideLoadingPopup();
        console.error('Error:', error);
        showCustomAlert('백엔드 서버에 연결할 수 없습니다. 잠시 후 다시 시도해주세요.');
    }
}

// ==================================================================
// SECTION 4: 찾기/바꾸기 및 실행 취소 (수정)
// ==================================================================
function simpleFindNext() { if (!mainTextArea) return; const term = document.getElementById('simpleFindText').value; if (!term) { showCustomAlert('찾을 단어를 입력하세요.'); return; } let searchStartIndex = mainTextArea.selectionEnd; let foundIndex = mainTextArea.value.indexOf(term, searchStartIndex); if (foundIndex === -1) { const wrapAroundIndex = mainTextArea.value.indexOf(term, 0); if (wrapAroundIndex === -1 || wrapAroundIndex === mainTextArea.selectionStart) { showCustomAlert('"' + term + '" 을(를) 문서에서 찾을 수 없습니다.'); return; } foundIndex = wrapAroundIndex; } mainTextArea.focus(); mainTextArea.setSelectionRange(foundIndex, foundIndex + term.length); }
function simpleReplaceCurrent() { 
    if (!mainTextArea) return;
    const activeTabId = document.querySelector('.Section2-3 .tab.active')?.dataset.tabId;
    if (!activeTabId) return;

    const term = document.getElementById('simpleFindText').value;
    const replacement = document.getElementById('simpleReplaceText').value;
    const start = mainTextArea.selectionStart;
    const end = mainTextArea.selectionEnd;

    if (start === end || mainTextArea.value.substring(start, end) !== term) {
        simpleFindNext();
        return;
    }
    
    if (!undoStack[activeTabId]) undoStack[activeTabId] = [];
    undoStack[activeTabId].push({ value: mainTextArea.value, selectionStart: start, selectionEnd: end });

    mainTextArea.value = mainTextArea.value.substring(0, start) + replacement + mainTextArea.value.substring(end);
    mainTextArea.setSelectionRange(start, start + replacement.length);
    simpleFindNext(); 
}
async function previewSelectionBeforeReplaceAll() { 
    if (!mainTextArea) return;
    const activeTabId = document.querySelector('.Section2-3 .tab.active')?.dataset.tabId;
    if (!activeTabId) return;

    const term = document.getElementById('simpleFindText').value;
    const replacement = document.getElementById('simpleReplaceText').value;
    if (!term) { showCustomAlert("찾을 단어를 입력하세요."); return; }

    const start = mainTextArea.selectionStart;
    const end = mainTextArea.selectionEnd;
    const scope = (start !== end) ? "선택된 영역" : "전체 문서";
    try {
        await showCustomConfirm(`'${term}' 을(를) '${replacement}' (으)로 ${scope}에서 모두 바꾸시겠습니까?`);
        
        if (!undoStack[activeTabId]) undoStack[activeTabId] = [];
        undoStack[activeTabId].push({ value: mainTextArea.value, selectionStart: start, selectionEnd: end });
        
        let count = 0;
        const regex = new RegExp(term.replace(/[.*+?^${}()|[\]\\]/g, '\\$&'), 'g');
        if (scope === "선택된 영역") {
            const selectedText = mainTextArea.value.substring(start, end);
            const replacedText = selectedText.replace(regex, (match) => { count++; return replacement; });
            mainTextArea.value = mainTextArea.value.substring(0, start) + replacedText + mainTextArea.value.substring(end);
            mainTextArea.setSelectionRange(start, start + replacedText.length);
        } else {
            mainTextArea.value = mainTextArea.value.replace(regex, (match) => { count++; return replacement; });
        }
        showCustomAlert(`총 ${count}개를 바꿨습니다.`);
    } catch (error) {
        console.log('모두 바꾸기 취소');
    }
}
function resetFindReplace() { if (!mainTextArea) return; document.getElementById('simpleFindText').value = ''; document.getElementById('simpleReplaceText').value = ''; mainTextArea.focus(); }
function performUndo() { 
    const activeTabId = document.querySelector('.Section2-3 .tab.active')?.dataset.tabId;
    if (!activeTabId || !undoStack[activeTabId] || undoStack[activeTabId].length === 0) return;
    
    const previous = undoStack[activeTabId].pop();
    mainTextArea.value = previous.value;
    mainTextArea.setSelectionRange(previous.selectionStart, previous.selectionEnd);
    mainTextArea.focus();
}

// ==================================================================
// SECTION 5: 탭 컴포넌트 관리 함수 (대규모 수정)
// ==================================================================
function createTabComponent(targetSelector, title, sessionData, getTabContentHtml, onTabActivatedCallback, onNewTabCallback) {
    const container = document.querySelector(targetSelector);
    if (!container) return;

    container.innerHTML = `<div style="padding: 5px 0 0 5px; font-weight: 600;"><span>${title}</span></div><div class="tab-content-area"></div><div class="tab-bar"><div class="tab-nav-start"><div class="tab-nav-button tab-scroll-btn" data-direction="-1">◀</div></div><div class="tab-list"></div><div class="tab-controls"><div class="tab-nav-button add-tab-btn">+</div><div class="tab-nav-button tab-scroll-btn" data-direction="1">▶</div></div></div>`;
    
    const tabList = container.querySelector('.tab-list');
    const tabContentArea = container.querySelector('.tab-content-area');
    const addButton = container.querySelector('.add-tab-btn');

    const activateTab = (tabToActivate) => {
        if (!tabToActivate) return;
        tabList.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        tabContentArea.querySelectorAll('.tab-content-pane').forEach(p => p.classList.remove('active'));
        tabToActivate.classList.add('active');
        const correspondingPane = tabContentArea.querySelector(`[data-tab-id="${tabToActivate.dataset.tabId}"]`);
        if (correspondingPane) {
            correspondingPane.classList.add('active');
            if (onTabActivatedCallback) onTabActivatedCallback(correspondingPane);
        }
    };

    const addTab = (tabId, tabName, isActive = false) => {
        const newTab = document.createElement('div');
        newTab.className = 'tab';
        if (isActive) newTab.classList.add('active');
        newTab.dataset.tabId = tabId;
        newTab.innerHTML = `<span>${tabName}</span><span class="close-tab">×</span>`;
        
        const newPane = document.createElement('div');
        newPane.className = 'tab-content-pane';
        if (isActive) newPane.classList.add('active');
        newPane.dataset.tabId = tabId;
        newPane.innerHTML = getTabContentHtml(tabId);
        
        tabList.appendChild(newTab);
        tabContentArea.appendChild(newPane);
        return newPane;
    };

    // --- 이벤트 리스너 ---
    addButton.addEventListener('click', () => {
        onNewTabCallback(container.classList[1]); // e.g., 'Section2-3'
    });

    tabList.addEventListener('click', async (event) => {
        const target = event.target;
        if (target.classList.contains('close-tab')) {
            event.stopPropagation();
            const tabToRemove = target.closest('.tab');
            if (tabList.querySelectorAll('.tab').length === 1) { return showCustomAlert('마지막 탭은 닫을 수 없습니다.'); }
            
            try {
                await showCustomConfirm(`'${tabToRemove.querySelector('span').textContent}' 탭을 닫으시겠습니까?`);
                const tabIdToRemove = tabToRemove.dataset.tabId;
                delete currentSessionData[tabIdToRemove];

                let nextTabToActivate = tabToRemove.previousElementSibling || tabToRemove.nextElementSibling;
                const paneToRemove = tabContentArea.querySelector(`[data-tab-id="${tabIdToRemove}"]`);
                tabToRemove.remove();
                if(paneToRemove) paneToRemove.remove();
                if (nextTabToActivate) activateTab(nextTabToActivate);
                
                await updateAndSaveSession();
            } catch (e) { console.log('탭 닫기 취소'); }
            return;
        }
        const clickedTab = target.closest('.tab');
        if (clickedTab && !clickedTab.classList.contains('active')) {
            activateTab(clickedTab);
        }
    });

    tabList.addEventListener('dblclick', (event) => {
        const spanToEdit = event.target.closest('.tab > span:first-of-type');
        if (!spanToEdit) return;
        
        const tab = spanToEdit.closest('.tab');
        const tabId = tab.dataset.tabId;
        const currentName = spanToEdit.textContent;
        const input = document.createElement('input');
        input.type = 'text';
        input.value = currentName;
        input.className = 'tab-edit-input';
        
        spanToEdit.style.display = 'none';
        spanToEdit.after(input);
        input.focus();
        input.select();

        const finishEditing = async () => {
            const newName = input.value.trim() || currentName;
            spanToEdit.textContent = newName;
            input.remove();
            spanToEdit.style.display = '';
            if (newName !== currentName) {
                currentSessionData[tabId].tabName = newName;
                await updateAndSaveSession();
            }
        };
        input.addEventListener('blur', finishEditing);
        input.addEventListener('keydown', e => e.key === 'Enter' && finishEditing());
    });
    
    container.querySelectorAll('.tab-scroll-btn').forEach(button => {
        button.addEventListener('click', () => {
            const direction = parseInt(button.dataset.direction, 10);
            tabList.scrollBy({ left: 200 * direction, behavior: 'smooth' });
        });
    });

    // --- 초기 탭 로드 ---
    if (sessionData && Object.keys(sessionData).length > 0) {
        Object.keys(sessionData).forEach(tabId => {
            const pane = addTab(tabId, sessionData[tabId].tabName);
            // 데이터 채우기
            const data = sessionData[tabId];
            if (container.classList.contains('Section2-3')) {
                pane.querySelector('#docTitle').value = data.docTitle || '';
                pane.querySelector('#mainTextArea').value = data.content || '';
                pane.querySelector('#memoTextArea').value = data.memoContent || '';
                if(data.settings) Object.keys(data.settings).forEach(key => {
                    const el = pane.querySelector(`#${key}`);
                    if (el) el.value = data.settings[key];
                });
            } else if (container.classList.contains('Section2-2')) {
                const chatMessages = pane.querySelector('.chat-messages');
                chatMessages.innerHTML = ''; // 기본 메시지 삭제
                if (data.messages) data.messages.forEach(msg => {
                    const msgDiv = document.createElement('div');
                    msgDiv.className = `message message-${msg.sender}`;
                    msgDiv.innerHTML = `<div class="message-wrapper"><div class="message-content">${msg.text.replace(/\n/g, '<br>')}</div><button class="copy-btn" title="내용 복사">📋</button></div>`;
                    msgDiv.querySelector('.copy-btn').addEventListener('click', () => navigator.clipboard.writeText(msg.text));
                    chatMessages.appendChild(msgDiv);
                });
            }
        });
    }
}

// ==================================================================
// SECTION 6: 페이지 초기화 및 기능별 담당 함수 (수정)
// ==================================================================
function onNewTab(componentType) {
    const prefix = componentType === 'Section2-3' ? 'editor' : (componentType === 'Section2-2' ? 'chat' : 'prompter');
    const newId = `${prefix}_${Date.now()}`;
    const newName = `${prefix === 'editor' ? '문서' : (prefix === 'chat' ? '대화' : '프롬프터')}${document.querySelectorAll(`.${componentType} .tab`).length + 1}`;
    
    // 기본 데이터 구조 생성
    currentSessionData[newId] = { tabName: newName, componentType };
    if (prefix === 'editor') {
        currentSessionData[newId].settings = { fontFamily: '바탕', fontSize: '12', lineSpacing: '1.5', paraSpacingAfter: '10', pageOrientation: 'PORTRAIT', marginTop: '2.0', marginBottom: '2.0', marginLeft: '2.5', marginRight: '2.5' };
    } else if (prefix === 'chat') {
        currentSessionData[newId].messages = [{ sender: 'assistant', text: '새로운 대화를 시작합니다.' }];
    }
    
    restoreUiFromSessionData(); // UI 전체 새로고침으로 새 탭 추가
    // 새 탭 활성화
    setTimeout(() => {
        document.querySelector(`.tab[data-tab-id="${newId}"]`)?.click();
    }, 0);
}

function initEditorFeature(data) {
    const onEditorTabActivated = (activePane) => {
        mainTextArea = activePane.querySelector('#mainTextArea');
        memoTextArea = activePane.querySelector('#memoTextArea');
        docTitleInput = activePane.querySelector('#docTitle');
        fontFamilySelect = activePane.querySelector('#fontFamily');
        fontSizeInput = activePane.querySelector('#fontSize');
        lineSpacingInput = activePane.querySelector('#lineSpacing');
        paraSpacingAfterInput = activePane.querySelector('#paraSpacingAfter');
        marginTopInput = activePane.querySelector('#marginTop');
        marginBottomInput = activePane.querySelector('#marginBottom');
        marginLeftInput = activePane.querySelector('#marginLeft');
        marginRightInput = activePane.querySelector('#marginRight');
    };
    createTabComponent('.Section2-3', '■ Editor', data, getEditorHtml, onEditorTabActivated, onNewTab);
}

function initAiChatFeature(data) {
    const setupChatPane = (chatPane) => {
        if (chatPane.dataset.chatInitialized) return;
        const messagesContainer = chatPane.querySelector('.chat-messages');
        const messageInput = chatPane.querySelector('.message-input');
        const sendButton = chatPane.querySelector('.send-btn');
        const activeTabId = chatPane.dataset.tabId;
        
        const sendMessage = async () => {
            const messageText = messageInput.value.trim();
            if (!messageText) return;
            
            messageInput.value = '';
            messageInput.style.height = 'auto';

            currentSessionData[activeTabId].messages.push({ sender: 'user', text: messageText });
            restoreUiFromSessionData(); // UI 업데이트

            // 임시 "답변 중" 메시지 표시를 위해 UI 즉시 업데이트
            setTimeout(async () => {
                const activeChatPane = document.querySelector(`.Section2-2 .tab-content-pane.active`);
                const messagesContainer = activeChatPane.querySelector('.chat-messages');
                
                const loadingMessageDiv = document.createElement('div');
                loadingMessageDiv.className = 'message message-assistant';
                loadingMessageDiv.innerHTML = `<div class="message-wrapper"><div class="message-content">답변 생성 중...</div></div>`;
                messagesContainer.appendChild(loadingMessageDiv);
                messagesContainer.scrollTop = messagesContainer.scrollHeight;

                try {
                    const chatHistory = (currentSessionData[activeTabId].messages || [])
                        .slice(0, -1) // 마지막 사용자 메시지 제외
                        .map(msg => ({ role: msg.sender === 'user' ? 'user' : 'model', parts: [{ text: msg.text }] }));

                    const response = await fetch("https://sraieditor20250711-983424591109.asia-northeast3.run.app/chat-gemini", {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ message: messageText, history: chatHistory }),
                    });
                    const data = await response.json();
                    const reply = response.ok ? data.reply : `오류: ${data.error || '알 수 없는 오류'}`;
                    currentSessionData[activeTabId].messages.push({ sender: 'assistant', text: reply });
                } catch (error) {
                    const errorMessage = `네트워크 오류: ${error.message}`;
                    currentSessionData[activeTabId].messages.push({ sender: 'assistant', text: errorMessage });
                } finally {
                    restoreUiFromSessionData(); // 최종 UI 업데이트
                    setTimeout(() => {
                        const finalMessagesContainer = document.querySelector(`.Section2-2 .tab-content-pane.active .chat-messages`);
                        if (finalMessagesContainer) finalMessagesContainer.scrollTop = finalMessagesContainer.scrollHeight;
                    }, 0);
                }
            }, 0);
        };
        sendButton.onclick = sendMessage;
        messageInput.onkeydown = (e) => { if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); sendMessage(); } };
        messageInput.oninput = () => { messageInput.style.height = 'auto'; messageInput.style.height = `${messageInput.scrollHeight}px`; };
        chatPane.dataset.chatInitialized = 'true';
    };
    createTabComponent('.Section2-2', '■ AI Chat', data, getAiChatHtml, setupChatPane, onNewTab);
}

function initPrompterFeature(data) {
    createTabComponent('.Section2-1', '■ Prompter Selector', data, getPrompterListHtml, null, onNewTab);
}


// ==================================================================
// SECTION 7: DOM 로딩 완료 후 실행 (수정)
// ==================================================================
document.addEventListener('DOMContentLoaded', () => {
    // 버튼 이벤트 리스너
    document.getElementById('google-sign-in-button').addEventListener('click', handleAuthClick);
    document.getElementById('google-sign-out-button').addEventListener('click', handleSignoutClick);
    
    // 전역 로딩 팝업 참조
    loadingPopup = document.getElementById('loadingPopup');

    // Google 스크립트 로드 완료 시 호출될 콜백 함수들을 window 객체에 할당
    window.onGapiLoaded = gapiLoaded;
    window.onGisLoaded = gisLoaded;

    // 로컬 스토리지에서 먼저 데이터를 로드하여 UI를 최대한 빨리 보여줌
    loadAndApplySessionData(false);

    // 키보드 단축키
    document.addEventListener('keydown', function(event) {
        if (event.altKey) {
            event.preventDefault();
            const keyMap = { '1': '{제목1.1}', '2': '{제목1.2}', '3': '{제목1.3}', '4': '{제목2.1}', '5': '{제목2.2}', '6': '{제목2.3}', '7': '{제목3.1}', '8': '{제목3.2}', '9': '{제목3.3}', 'q': '{왼쪽}', 'w': '{가운데}', 'e': '{오른쪽}', 'r': '{양쪽}', 't': '{균등}', 'y': '{10pt}', 'u': '{1줄}', 'i': '{들여쓰기,1번줄:0.5,2번줄이하:0.5}', 'o': '{들여쓰기,1번줄:1,2번줄이하:1}', 'p': '{들여쓰기,1번줄:0,2번줄이하:0.5}', '[': '{들여쓰기,1번줄:0.5,2번줄이하:1}', 'a': '{진하게}', 's': '{밑줄}', 'd': '{>>}', 'f': '{<<}', 'g': '{탭}', 'h': '{줄바꿈}', 'j': '{문단바꿈}', 'k': '{페이지바꿈}', 'z': '{표시작1,글꼴=??,크기=#}', 'x': '{표시작1,테두리없음}', 'c': '{표끝1}', 'v': '{표시작2,글꼴=??,크기=#}', 'b': '{표끝2}', 'n': '{제목행}', 'm': '{회색}', ',': '{남색}', '.': '{그림:~}' };
            const syntax = keyMap[event.key.toLowerCase()];
            if (syntax && mainTextArea) insertSyntax(syntax);
        }
        if ((event.ctrlKey || event.metaKey) && event.key.toLowerCase() === 'z') {
            event.preventDefault();
            performUndo();
        }
        if ((event.ctrlKey || event.metaKey) && event.key.toLowerCase() === 's') { 
            event.preventDefault(); 
            updateAndSaveSession(); 
        }
        if (event.key === 'PageDown') { event.preventDefault(); if (mainTextArea) handleContextScroll(true); }
        if (event.key === 'PageUp') { event.preventDefault(); if (mainTextArea) handleContextScroll(false); }
    });
});
    
</script>

<script async defer src="https://apis.google.com/js/api.js" onload="onGapiLoaded()"></script>
<script async defer src="https://accounts.google.com/gsi/client" onload="onGisLoaded()"></script>
</body>
</html>
