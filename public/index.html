<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SaeRo AI Editor</title>

    <script src="https://unpkg.com/docx@8.5.0/build/index.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.0/FileSaver.min.js"></script>

    <script async defer src="https://apis.google.com/js/api.js"></script>
    <script async defer src="https://accounts.google.com/gsi/client" onload="gisLoaded()"></script>
    
<style>
    /* ================================================================== */
    /* == ê¸°ë³¸ ë° ì „ì²´ ë ˆì´ì•„ì›ƒ (Redesigned by Gemini v3.2 Final) == */
    /* ================================================================== */
    :root {
        --primary-color: #007bff;
        --secondary-color: #5a6268;
        --danger-color: #dc3545;
        --warning-color: #ffc107;
        --border-color: #dee2e6;
        --background-color: #f8f9fa;
        --section-background: #ffffff;
        --text-color: #212529;
        --text-secondary-color: #495057;
        --font-family-main: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
    }

    html { box-sizing: border-box; }
    *, *:before, *:after { box-sizing: inherit; }
    html, body {
        margin: 0; padding: 0; height: 100%;
        font-family: var(--font-family-main);
        background-color: var(--background-color);
        color: var(--text-color);
        overflow: hidden;
    }
    .main-container {
        display: flex;
        flex-direction: column;
        height: 100vh;
    }
    .Section1 {
        height: 45px;
        background-color: var(--section-background);
        border-bottom: 1px solid var(--border-color);
        padding: 0 20px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        flex-shrink: 0;
    }
    .brand-logo { font-weight: bold; color: #c62828; font-size: 1.2em; }
    .brand-highlight { color: black; }
    .user-info { font-size: 0.9em; color: var(--text-secondary-color); }
    
    .content-container {
        flex-grow: 1;
        display: flex;
        padding: 12px;
        gap: 12px;
        overflow: hidden;
    }
    .content-column {
        flex: 1;
        display: flex;
        flex-direction: column;
        min-width: 0;
        background-color: var(--section-background);
        border: 1px solid var(--border-color);
        border-radius: 8px;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
    }
    
    /* ================================================================== */
    /* == íƒ­ ì‹œìŠ¤í…œ ìŠ¤íƒ€ì¼ (Redesigned by Gemini v3.2 Final) == */
    /* ================================================================== */
    .tab-content-area {
        flex: 1;
        margin-top: 10px;
        display: flex;
        padding: 0 10px 10px 10px;
        overflow: hidden;
    }
    .tab-content-pane { display: none; }
    .tab-content-pane.active {
        display: flex; /* flexë¡œ ë³€ê²½í•˜ì—¬ ë‚´ë¶€ .containerê°€ ë†’ì´ë¥¼ 100% ì±„ìš°ë„ë¡ í•¨ */
        flex-direction: column;
        flex: 1;
        overflow-y: auto;
    }
    .tab-bar {
        height: 40px;
        background-color: transparent;
        display: flex;
        flex-shrink: 0;
        border-bottom: 1px solid var(--border-color); 
        padding: 0 10px;
    }
    .tab-list { 
        display: flex; 
        flex: 1; 
        overflow: hidden;
        white-space: nowrap; 
        align-items: center;
    }
    .tab-list::-webkit-scrollbar { display: none; }
    .tab-list { -ms-overflow-style: none; scrollbar-width: none; }

    .tab { 
        padding: 8px 12px; 
        cursor: pointer; 
        background-color: transparent; 
        border: 1px solid var(--border-color);
        color: var(--text-secondary-color);
        transition: all 0.2s ease-in-out;
        flex-shrink: 0;
        border-radius: 6px; 
        margin-right: 5px;
        border-bottom-left-radius: 0; /* ì•„ë˜ìª½ ëª¨ì„œë¦¬ ê° ì œê±° */
        border-bottom-right-radius: 0;
    }
    .tab:hover { 
        background-color: #e9ecef;
        color: var(--text-color); 
    }
    .tab.active { 
        background-color: #007bff; /* ì§„í•œ íšŒìƒ‰ ë°°ê²½ */
        color: white;              /* í°ìƒ‰ ê¸€ì */
        font-weight: 600;          /* êµµì€ ê¸€ì”¨ì²´ */
        border-color: #007bff;     /* í…Œë‘ë¦¬ë„ ê°™ì€ ìƒ‰ìœ¼ë¡œ í†µì¼ */
    }

    .tab-nav-start, /* ì‰¼í‘œë¥¼ ì´ìš©í•´ ìƒˆ í´ë˜ìŠ¤ ì¶”ê°€ */
    .tab-controls { 
        display: flex; 
        align-items: center; /* ìì‹ ìš”ì†Œë¥¼ ì„¸ë¡œ ì¤‘ì•™ ì •ë ¬ */
        margin-right: 4px;
    }
    
    .tab-nav-button { 
        padding: 0 10px; height: 28px; display: flex; align-items: center; justify-content: center; 
        background-color: #fff; border: 1px solid var(--border-color); cursor: pointer; 
        font-size: 1.1em; color: var(--text-secondary-color); border-radius: 6px; margin-left: 5px;
    }
    .tab-nav-button:hover { background-color: #e9ecef; }
    .close-tab { margin-left: 8px; font-size: 14px; line-height: 1; padding: 2px; border-radius: 50%; }
    .close-tab:hover { background-color: #dee2e6; }
    .tab-edit-input { border: 1px solid var(--primary-color); outline: none; padding: 1px 3px; width: 80px; font-family: inherit; font-size: inherit; border-radius: 3px; }

    /* ================================================================== */
    /* == í¸ì§‘ê¸° ë‚´ë¶€ ìŠ¤íƒ€ì¼ (Redesigned by Gemini v3.2 Final) == */
    /* ================================================================== */
    .container {
        width: 100%; height: 100%; display: flex; flex-direction: column; gap: 10px;
    }
    .section {
        background-color: #f8f9fa;
        padding: 12px;
        border: 1px solid #e9ecef;
        border-radius: 8px;
        flex-shrink: 0;
    }
    
    .form-group { display: flex; align-items: center; width: auto; }
    .form-group label { margin-right: 8px; color: var(--text-secondary-color); flex-shrink: 0; font-size: 12px; }
    .form-group input, .form-group select {
        padding: 6px 8px; border: 1px solid var(--border-color); border-radius: 6px; 
        font-size: 12px; transition: border-color 0.2s, box-shadow 0.2s;
    }
    .form-group input:focus, .form-group select:focus {
        outline: none;
        border-color: var(--primary-color);
        box-shadow: 0 0 0 3px rgba(0, 123, 255, 0.15);
    }
    #docTitle { flex-grow: 1; }

    .global-settings-grid, .syntax-buttons-wrapper {
        display: flex;
        flex-wrap: nowrap;
        overflow-x: auto;
        padding-bottom: 10px;
    }
    .global-settings-grid {
        gap: 30px; /* ì„¤ì • í•­ëª© ì‚¬ì´ì˜ ê°„ê²©ì„ 16pxë¡œ ëŠ˜ë¦½ë‹ˆë‹¤ */
        align-items: center;
    }
    .syntax-buttons-wrapper {
        gap: 4px; /* ë²„íŠ¼ ì‚¬ì´ ê°„ê²©ì€ 4pxë¡œ ìœ ì§€ */
    }    

    .global-settings-grid .form-group input,
    .global-settings-grid .form-group select {
        width: 80px; /* ëª¨ë“  ì…ë ¥ì°½ì˜ ë„ˆë¹„ë¥¼ 90pxë¡œ ê³ ì • */
    }

    .syntax-buttons-wrapper button { 
        height: 30px; 
        width: 100px;  /* ê°€ë¡œ í¬ê¸° 100pxë¡œ ê³ ì • */
        padding: 0 10px; /* ë‚´ë¶€ ì—¬ë°± ì¡°ì • */
        font-size: 11px; 
        color: white; 
        border: none; 
        border-radius: 4px; 
        cursor: pointer; 
        transition: filter 0.2s;
        display: flex;
        align-items: center;
        justify-content: space-between;
    }
    
    .syntax-buttons-wrapper .button-text {
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        text-align: left;
        flex-grow: 1;
    }
    .syntax-buttons-wrapper small {
        margin-left: 6px;
        flex-shrink: 0; /* ë‹¨ì¶•í‚¤ê°€ ì¤„ì–´ë“¤ì§€ ì•Šë„ë¡ ì„¤ì • */
    }
    
    .syntax-buttons-wrapper button:hover { filter: brightness(1.15); }
    .syntax-buttons-wrapper button.group1 { background-color: #0056b3; }
    .syntax-buttons-wrapper button.group2 { background-color: #138496; }
    .syntax-buttons-wrapper button.group3 { background-color: #1e7e34; }
    .syntax-buttons-wrapper button.group4 { background-color: #d39e00; color: white; }
    .syntax-buttons-wrapper button.group5 { background-color: #563d7c; }

    .simple-find-replace-bar { display: flex; flex-direction: column; gap: 8px; }
    .find-replace-inputs { display: flex; gap: 10px; width: 100%; align-items: center; }
    .find-replace-inputs label { display: flex; align-items: center; gap: 5px; font-size: 12px; }
    .find-replace-inputs input { width: 200px }
    .find-replace-buttons { display: flex; flex-wrap: wrap; gap: 6px; }
    .syntax-button-like { background-color: #fff; border: 1px solid var(--border-color); border-radius: 6px; font-size: 11.5px; padding: 4px 8px; cursor: pointer; transition: background-color 0.2s; }
    .syntax-button-like:hover { background-color: #f1f3f5; }

    #mainTextArea, #memoTextArea {Â 
        width: 100%; height: 100%; border: 1px solid var(--border-color);Â 
        resize: none;
        font-family: var(--font-family-main); /* ê¸€ê¼´ì„ ë‹¤ë¥¸ UIì™€ ë™ì¼í•˜ê²Œ ì§€ì • */
        font-size: 12px; /* "ì°¾ê¸°:"ì™€ ê°™ì€ í¬ê¸°ë¡œ ìˆ˜ì • */
        line-height: 1.6; padding: 12px;
        border-radius: 8px;
    }
    
    #mainTextArea:focus, #memoTextArea:focus {
        outline: none; border-color: var(--primary-color);
        box-shadow: 0 0 0 3px rgba(0, 123, 255, 0.15);
    }
    /* â–¼â–¼â–¼ [ìˆ˜ì •] í…ìŠ¤íŠ¸ ì…ë ¥ì°½ì„ ê°ì‹¸ëŠ” ì»¨í…Œì´ë„ˆ ìŠ¤íƒ€ì¼ ë³µì› â–¼â–¼â–¼ */
    .main-editor-area { flex-grow: 1; display: flex; flex-direction: column; }
    .section[style*="min-height"] { flex-grow: 1; display: flex; flex-direction: column; }
    
    .action-buttons { 
        display: flex; justify-content: flex-end; gap: 8px; 
        margin-top: auto;
        padding-top: 6px;
        flex-wrap: nowrap;
        flex-shrink: 0;
    } 
    .action-buttons button { 
        padding: 8px 16px; border: none; border-radius: 6px; cursor: pointer; 
        font-weight: 600; font-size: 13px; transition: all 0.2s ease-in-out; white-space: nowrap;
    }
    .action-buttons button:hover { transform: translateY(-2px); box-shadow: 0 4px 8px rgba(0,0,0,0.1); }
    .action-buttons .open-drive { background-color: var(--primary-color); color: white; }
    .action-buttons .load-file { background-color: var(--secondary-color); color: white; } 
    .action-buttons .save-draft { background-color: var(--warning-color); color: black; }
    .action-buttons .create-doc { background-color: #28a745; color: white; }
    .action-buttons .delete-all { background-color: var(--danger-color); color: white; }

    .Section3 {
        height: 30px;
        background-color: var(--background-color);
        border-top: 1px solid var(--border-color);
        padding: 0 20px;
        font-size: 11px;
        color: var(--text-secondary-color);
        display: flex;
        align-items: center;
        flex-shrink: 0;
    }

/* ================================================================== */
/* == AI ì±„íŒ… UI ìŠ¤íƒ€ì¼ (v2 - Gemini Layout) == */
/* ================================================================== */
.chat-container {
    width: 100%; height: 100%; display: flex; flex-direction: column;
    overflow: hidden; background-color: #fff;
}
.chat-messages {
    flex-grow: 1; overflow-y: auto; padding: 4px 4px;
    display: flex; flex-direction: column; gap: 15px;
}
.message {
    display: flex; max-width: 85%; align-self: flex-start;
}
.message-user {
    align-self: flex-end;
}
.message-content {
    padding: 12px 18px; border-radius: 18px; background-color: #f1f3f5;
    color: var(--text-color); line-height: 1.6; white-space: pre-wrap;
    font-family: var(--font-family-main); font-size: 13px;
}
.message-user .message-content {
    background-color: var(--primary-color); color: white;
}

.message-wrapper {
    display: flex;
    align-items: flex-start; /* ë²„íŠ¼ê³¼ ë§í’ì„  ìƒë‹¨ ì •ë ¬ */
    gap: 8px;
}

/* ìˆ˜ì • í›„ ì½”ë“œ */
.copy-btn {
    flex-shrink: 0;
    border: none; /* í…Œë‘ë¦¬ ì œê±° */
    background-color: transparent; /* ë°°ê²½ íˆ¬ëª…í•˜ê²Œ */
    color: var(--text-secondary-color);
    border-radius: 6px;
    width: 32px;
    height: 32px;
    cursor: pointer;
    font-size: 16px;
    margin-top: 5px;
    transition: background-color 0.2s, color 0.2s; /* ìƒ‰ìƒ ë³€ê²½ ì• ë‹ˆë©”ì´ì…˜ ì¶”ê°€ */
    opacity: 0.5; /* í‰ì†Œì—ëŠ” ë°˜íˆ¬ëª…í•˜ê²Œ */
}
.copy-btn:hover {
    background-color: #e9ecef;
    color: var(--text-color); /* ë§ˆìš°ìŠ¤ ì˜¬ë¦¬ë©´ ì§„í•˜ê²Œ */
    opacity: 1; /* ë§ˆìš°ìŠ¤ ì˜¬ë¦¬ë©´ ë¶ˆíˆ¬ëª…í•˜ê²Œ */
}
/* ì‚¬ìš©ì ë§í’ì„  ìª½ ë³µì‚¬ ë²„íŠ¼ì€ ì™¼ìª½ìœ¼ë¡œ ì´ë™ */
.message-user .message-wrapper {
    flex-direction: row-reverse; /* ë‚´ìš©ê³¼ ë²„íŠ¼ ìˆœì„œ ë’¤ì§‘ê¸° */
}
    
/* --- â–¼â–¼â–¼ í•µì‹¬ ìˆ˜ì • ì˜ì—­ â–¼â–¼â–¼ --- */

.chat-input-section {
    padding: 4px;
    border-top: 1px solid var(--border-color);
    background-color: #fff;
    flex-shrink: 0;
    margin-top: 1px;
}

/* ì²¨ë¶€íŒŒì¼ ìŠ¤í¬ë¡¤ ì»¨í…Œì´ë„ˆ */
.file-preview-container-wrapper {
    overflow-x: auto; /* ë‚´ìš©ì´ ë„˜ì¹˜ë©´ ê°€ë¡œ ìŠ¤í¬ë¡¤ ìƒì„± */
    padding-bottom: 8px; /* ìŠ¤í¬ë¡¤ë°”ì™€ ì…ë ¥ì°½ ì‚¬ì´ ê°„ê²© */
}
/* ìŠ¤í¬ë¡¤ë°” ìˆ¨ê¸°ê¸° (ì„ íƒ ì‚¬í•­) */
.file-preview-container-wrapper::-webkit-scrollbar {
    height: 5px;
}
.file-preview-container-wrapper::-webkit-scrollbar-thumb {
    background: #ccc; border-radius: 5px;
}

/* ì‹¤ì œ ì²¨ë¶€íŒŒì¼ ì•„ì´í…œë“¤ì„ ë‹´ëŠ” ê³³ */
.file-preview-container {
    display: flex; /* ê°€ë¡œë¡œ ë°°ì—´ */
    flex-wrap: nowrap; /* ì¤„ë°”ê¿ˆ ì—†ìŒ */
    gap: 8px;
    padding-top: 2px; /* ìœ„ìª½ ì—¬ë°± */
    min-height: 20px; /* íŒŒì¼ì´ ì—†ì„ ë•Œë„ ìµœì†Œ ë†’ì´ ìœ ì§€ */
}

.file-preview-item {
    display: flex; align-items: center; gap: 6px;
    background: #e9ecef; padding: 4px 10px; border-radius: 16px; /* ë‘¥ê·¼ ì•Œì•½ í˜•íƒœ */
    font-size: 12px;
    flex-shrink: 0; /* í¬ê¸° ì¤„ì–´ë“¤ì§€ ì•ŠìŒ */
    white-space: nowrap; /* íŒŒì¼ ì´ë¦„ ì¤„ë°”ê¿ˆ ë°©ì§€ */
}
.file-preview-item .remove-file-btn {
    cursor: pointer; font-size: 16px; line-height: 1; padding: 0 2px;
    margin-left: 4px;
}

/* ì…ë ¥ì°½ ì „ì²´ë¥¼ ê°ì‹¸ëŠ” ë˜í¼ */
.chat-input-wrapper {
    display: flex;
    flex-direction: column; /* ì„¸ë¡œë¡œ ë°°ì—´ (ì…ë ¥ì°½ê³¼ ë²„íŠ¼ ê·¸ë£¹) */
    gap: 8px;
    padding: 10px; border: 1px solid #ccc;
    border-radius: 12px; background-color: #f8f9fa;
    transition: box-shadow 0.2s;
}
.chat-input-wrapper:focus-within {
    border-color: var(--primary-color);
    box-shadow: 0 0 0 2px rgba(0, 123, 255, 0.15);
}

/* í…ìŠ¤íŠ¸ ì…ë ¥ì°½ */
.message-input {
    width: 100%; /* ë„ˆë¹„ 100% */
    border: none; outline: none; padding: 4px 0;
    font-size: 14px; background-color: transparent; resize: none;
    max-height: 150px; overflow-y: auto; line-height: 1.5;
}

/* ë²„íŠ¼ë“¤ì„ ê°ì‹¸ëŠ” ê·¸ë£¹ */
.chat-button-group {
    display: flex;
    justify-content: flex-end; /* ë²„íŠ¼ë“¤ì„ ì™¼ìª½ë¶€í„° ì •ë ¬ */
    gap: 8px;
    width: 100%;
}

/* File, ë³´ë‚´ê¸° ë²„íŠ¼ ê³µí†µ ìŠ¤íƒ€ì¼ */
.chat-tool-btn {
    border-radius: 8px; border: 1px solid #ccc;
    background-color: #fff; cursor: pointer;
    font-size: 13px; font-weight: 500;
    display: flex; align-items: center; justify-content: center;
    transition: background-color 0.2s;
    padding: 6px 14px;
}
.chat-tool-btn:hover {
    background-color: #e9ecef;
}

/* ë³´ë‚´ê¸° ë²„íŠ¼ ì „ìš© ìŠ¤íƒ€ì¼ */
.chat-tool-btn.send-btn {
    width: 40px; /* ì •ì‚¬ê°í˜•ì— ê°€ê¹ê²Œ */
    height: 32px;
    padding: 0;
    border-radius: 8px; /* ë™ê·¸ë€ ë²„íŠ¼ì—ì„œ ì‚¬ê°í˜•ìœ¼ë¡œ ë³€ê²½ */
    background-color: var(--primary-color);
    color: white;
    font-size: 1.2em;
}
.chat-tool-btn.send-btn:hover {
    filter: brightness(1.1);
}

/* ================================================================== */
/* == íŒì—… ë° ë¡œë”© ì°½ ìŠ¤íƒ€ì¼ (ìµœìƒìœ„ z-index ì ìš©) == */
/* ================================================================== */
.loading-popup,
.custom-alert-popup {
    position: fixed; /* í™”ë©´ ì „ì²´ë¥¼ ê¸°ì¤€ìœ¼ë¡œ ìœ„ì¹˜ */
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0, 0, 0, 0.4); /* ë°˜íˆ¬ëª… ë°°ê²½ */
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 10000; /* ë‹¤ë¥¸ ëª¨ë“  ìš”ì†Œë“¤ë³´ë‹¤ ìœ„ì— ìˆë„ë¡ ë†’ì€ ê°’ ì„¤ì • */
    padding: 20px;
    box-sizing: border-box;
}

.loading-popup-content,
.custom-alert-content {
    background-color: white;
    padding: 25px 35px;
    border-radius: 12px;
    box-shadow: 0 5px 20px rgba(0, 0, 0, 0.2);
    text-align: center;
    max-width: 400px;
    width: 100%;
}

.custom-alert-content p,
.loading-popup-content p {
    margin: 0 0 20px 0;
    font-size: 16px;
    color: var(--text-color);
}

.custom-alert-content .button-group {
    display: flex;
    gap: 10px;
    justify-content: center;
}

.custom-alert-content button,
.loading-popup-content button {
    padding: 8px 20px;
    border: 1px solid #ccc;
    border-radius: 6px;
    cursor: pointer;
    background-color: #f8f9fa;
    font-size: 14px;
    font-weight: 500;
    min-width: 80px;
}
.custom-alert-content button:hover,
.loading-popup-content button:hover {
    background-color: #e9ecef;
}

/* í™•ì¸, ì·¨ì†Œ ë²„íŠ¼ ë“± íŠ¹ì • ë²„íŠ¼ì— ëŒ€í•œ ìŠ¤íƒ€ì¼ */
.custom-alert-content #customConfirmOkButton,
.custom-alert-content #customAlertOkButton {
    background-color: var(--primary-color);
    color: white;
    border-color: var(--primary-color);
}
.custom-alert-content #customConfirmOkButton:hover,
.custom-alert-content #customAlertOkButton:hover {
    filter: brightness(1.1);
}

/* ë¡œë”©ë°” ìŠ¤íƒ€ì¼ */
.progress-bar-container {
    height: 8px;
    width: 100%;
    background-color: #e9ecef;
    border-radius: 4px;
    overflow: hidden;
    margin-top: 10px;
}
.progress-bar-animated {
    width: 100%;
    height: 100%;
    background-color: var(--primary-color);
    border-radius: 4px;
    background-image: linear-gradient(45deg, rgba(255, 255, 255, .15) 25%, transparent 25%, transparent 50%, rgba(255, 255, 255, .15) 50%, rgba(255, 255, 255, .15) 75%, transparent 75%, transparent);
    background-size: 40px 40px;
    animation: progress-bar-stripes 1s linear infinite;
}

@keyframes progress-bar-stripes {
    from { background-position: 40px 0; }
    to { background-position: 0 0; }
}
    
</style>
    
</head>
<body>
    <div class="main-container">
        <div class="Section1">
            <span class="brand-logo">SaeRo <span class="brand-highlight">AI Editor</span></span>
            
            <div style="display: flex; align-items: center; gap: 20px; font-size: 0.9em; color: var(--text-secondary-color);">
                <span>[<span id="user-name"></span>, <span id="user-phone"></span>]</span>
                <span id="google-auth-container">
                    <button id="google-sign-in-button" disabled style="padding: 6px 12px; border-radius: 6px; border: 1px solid #ccc; background-color: #f8f9fa; cursor: pointer; font-size: 12px;">Google ë¡œê·¸ì¸</button>
                    <button id="google-sign-out-button" style="display: none; padding: 6px 12px; border-radius: 6px; border: 1px solid #dc3545; background-color: #fbebee; color: #dc3545; cursor: pointer; font-size: 12px;">ë¡œê·¸ì•„ì›ƒ</button>
                </span>
            </div>
        </div>

        <div class="content-container">
            <div class="content-column Section2-1"></div>
            <div class="content-column Section2-2"></div>
            <div class="content-column Section2-3"></div>
        </div>

        <div class="Section3">
            <p>&copy; 2025 ë²•ë¥ ì‚¬ë¬´ì†Œ ìƒˆë¡œ ë°•ì˜ˆì¤€. All Rights Reserved.</p>
        </div>
    </div>
  <div id="loadingPopup" class="loading-popup" style="display: none;"> 
    <div class="loading-popup-content"> <p>ì‘ì—… ì§„í–‰ ì¤‘... <span id="loadingTimeElapsed">[0.00 Sec]</span></p> <div class="progress-bar-container"><div class="progress-bar-animated"></div></div></div> 
  </div>
  <div id="customConfirm" class="custom-alert-popup" style="display: none;">
    <div class="custom-alert-content"> <p id="customConfirmMessage"></p> <div class="button-group"><button id="customConfirmOkButton">í™•ì¸</button><button id="customConfirmCancelButton">ì·¨ì†Œ</button></div></div>
  </div>
  <div id="customAlert" class="custom-alert-popup" style="display: none;">
    <div class="custom-alert-content"> <p id="customAlertMessage"></p> <button id="customAlertOkButton">í™•ì¸</button></div>
  </div>

    

<script>

// ==================================================================
// ìµœì¢… ìˆ˜ì •ëœ ì „ì²´ ìŠ¤í¬ë¦½íŠ¸ ì½”ë“œ
// ==================================================================

// --- ì „ì—­ ë³€ìˆ˜ ì„ ì–¸ ---

// --- Google API ë° ìƒíƒœ ê´€ë¦¬ ë³€ìˆ˜ ---
const CLIENT_ID = '983424591109-l4r2v7jnvmnrr8h1mm1j688k0h87spv4.apps.googleusercontent.com';
const SCOPES = 'https://www.googleapis.com/auth/drive.file https://www.googleapis.com/auth/userinfo.profile';
const SESSION_DATA_FILE_NAME = 'storage.json';

let gapiInited = false;
let gisInited = false;
let tokenClient;
let googleUser = { isSignedIn: () => false };

let currentSessionData = {}; // ì•±ì˜ ìƒíƒœë¥¼ ì €ì¥í•˜ëŠ” ì¤‘ì•™ ê°ì²´
const AUTO_SAVE_INTERVAL = 20 * 1000; // 20ì´ˆ
let autoSaveTimerIntervalId = null;
    
const userName = "ë°•ì˜ˆì¤€2";
const userPhone = "010-9876-5432";
let mainTextArea, memoTextArea, docTitleInput, fontFamilySelect, fontSizeInput, lineSpacingInput, paraSpacingAfterInput, loadingPopup, marginTopInput, marginBottomInput, marginLeftInput, marginRightInput;

let undoStack = {}; // ğŸ’¡ ë°°ì—´([])ì´ ì•„ë‹Œ ê°ì²´({})ë¡œ ë³€ê²½í•´ì•¼ í•©ë‹ˆë‹¤.
let loadingTimerIntervalId = null;
let loadingStartTime = 0;

let isDomReady = false;
let isGapiReady = false;
    
// ==================================================================
// SECTION 1: HTML ì½˜í…ì¸  ìƒì„± í•¨ìˆ˜
// ==================================================================

function getPrompterListHtml() {
    return `<ul><li>í”„ë¡¬í”„í„° í•­ëª© 1</li><li>í”„ë¡¬í”„í„° í•­ëª© 2</li><li>í”„ë¡¬í”„í„° í•­ëª© 3</li></ul>`;
}

function getEditorHtml() {
    return `
      <div class="container">
        <div class="section">
          <div class="form-group"> 
            <label for="docTitle">ë¬¸ì„œì œëª©:</label>
            <input type="text" id="docTitle" placeholder="ì…ë ¥í•˜ì§€ ì•Šìœ¼ë©´ ë‚ ì§œ/ì‹œê°„ìœ¼ë¡œ ìë™ ìƒì„±">
          </div>
        </div>
        <div class="section">
          <div class="global-settings-grid">
            <div class="form-group"> <label for="fontFamily">ê¸€ê¼´:</label> <select id="fontFamily"> <option value="Noto Sans KR">Noto Sans KR</option> <option value="Malgun Gothic">ë§‘ì€ ê³ ë”•</option> <option value="Arial">Arial</option> <option value="Times New Roman">Times New Roman</option> <option value="Calibri">Calibri</option> <option value="Batang" selected>ë°”íƒ•</option> <option value="Dotum">ë‹ì›€</option> </select> </div>
            <div class="form-group"> <label for="fontSize">í¬ê¸°(pt):</label> <input type="number" id="fontSize" value="12" min="8"> </div>
            <div class="form-group"> <label for="lineSpacing">ì¤„ê°„ê²©:</label> <input type="number" id="lineSpacing" value="1.5" step="0.1" min="1"> </div>
            <div class="form-group"> <label for="paraSpacingAfter">ë¬¸ë‹¨ë’¤(pt):</label> <input type="number" id="paraSpacingAfter" value="10" min="0"> </div>
            <div class="form-group"> <label for="pageOrientation">ìš©ì§€ë°©í–¥:</label> <select id="pageOrientation"> <option value="PORTRAIT" selected>ì„¸ë¡œ</option> <option value="LANDSCAPE">ê°€ë¡œ</option></select></div> 
            <div class="form-group"> <label for="marginTop">ì—¬ë°±-ìœ„(cm):</label> <input type="number" id="marginTop" value="2.0" step="0.1" min="0"> </div>
            <div class="form-group"> <label for="marginBottom">ì—¬ë°±-ì•„ë˜(cm):</label> <input type="number" id="marginBottom" value="2.0" step="0.1" min="0"> </div>
            <div class="form-group"> <label for="marginLeft">ì—¬ë°±-ì¢Œ(cm):</label> <input type="number" id="marginLeft" value="2.5" step="0.1" min="0"> </div>
            <div class="form-group"> <label for="marginRight">ì—¬ë°±-ìš°(cm):</label> <input type="number" id="marginRight" value="2.5" step="0.1" min="0"> </div>
          </div>
        </div>
        <div class="section">
            <div class="syntax-buttons-wrapper">
                <button class="group1" onclick="insertSyntax('{ì œëª©1.1}')" title="{ì œëª©1.1}"><span class="button-text">{ì œëª©1.1}</span><small>[Alt+1]</small></button>
                <button class="group1" onclick="insertSyntax('{ì œëª©1.2}')" title="{ì œëª©1.2}"><span class="button-text">{ì œëª©1.2}</span><small>[Alt+2]</small></button>
                <button class="group1" onclick="insertSyntax('{ì œëª©1.3}')" title="{ì œëª©1.3}"><span class="button-text">{ì œëª©1.3}</span><small>[Alt+3]</small></button>
                <button class="group1" onclick="insertSyntax('{ì œëª©2.1}')" title="{ì œëª©2.1}"><span class="button-text">{ì œëª©2.1}</span><small>[Alt+4]</small></button>
                <button class="group1" onclick="insertSyntax('{ì œëª©2.2}')" title="{ì œëª©2.2}"><span class="button-text">{ì œëª©2.2}</span><small>[Alt+5]</small></button>
                <button class="group1" onclick="insertSyntax('{ì œëª©2.3}')" title="{ì œëª©2.3}"><span class="button-text">{ì œëª©2.3}</span><small>[Alt+6]</small></button>
                <button class="group1" onclick="insertSyntax('{ì œëª©3.1}')" title="{ì œëª©3.1}"><span class="button-text">{ì œëª©3.1}</span><small>[Alt+7]</small></button>
                <button class="group1" onclick="insertSyntax('{ì œëª©3.2}')" title="{ì œëª©3.2}"><span class="button-text">{ì œëª©3.2}</span><small>[Alt+8]</small></button>
                <button class="group1" onclick="insertSyntax('{ì œëª©3.3}')" title="{ì œëª©3.3}"><span class="button-text">{ì œëª©3.3}</span><small>[Alt+9]</small></button>
                <button class="group2" onclick="insertSyntax('{ì™¼ìª½}')" title="{ì™¼ìª½}"><span class="button-text">{ì™¼ìª½}</span><small>[Alt+Q]</small></button>
                <button class="group2" onclick="insertSyntax('{ê°€ìš´ë°}')" title="{ê°€ìš´ë°}"><span class="button-text">{ê°€ìš´ë°}</span><small>[Alt+W]</small></button>
                <button class="group2" onclick="insertSyntax('{ì˜¤ë¥¸ìª½}')" title="{ì˜¤ë¥¸ìª½}"><span class="button-text">{ì˜¤ë¥¸ìª½}</span><small>[Alt+E]</small></button>
                <button class="group2" onclick="insertSyntax('{ì–‘ìª½}')" title="{ì–‘ìª½}"><span class="button-text">{ì–‘ìª½}</span><small>[Alt+R]</small></button>
                <button class="group2" onclick="insertSyntax('{ê· ë“±}')" title="{ê· ë“±}"><span class="button-text">{ê· ë“±}</span><small>[Alt+T]</small></button>
                <button class="group2" onclick="insertSyntax('{10pt}')" title="{10pt}"><span class="button-text">{10pt}</span><small>[Alt+Y]</small></button>
                <button class="group2" onclick="insertSyntax('{1ì¤„}')" title="{1ì¤„}"><span class="button-text">{1ì¤„}</span><small>[Alt+U]</small></button>
                <button class="group2" onclick="insertSyntax('{ë“¤ì—¬ì“°ê¸°,1ë²ˆì¤„:0.5,2ë²ˆì¤„ì´í•˜:0.5}')" title="{ë“¤ì—¬ì“°ê¸°,1ë²ˆì¤„:0.5,2ë²ˆì¤„ì´í•˜:0.5}"><span class="button-text">{ë“¤ì—¬ì“°ê¸°...}</span><small>[Alt+I]</small></button>
                <button class="group2" onclick="insertSyntax('{ë“¤ì—¬ì“°ê¸°,1ë²ˆì¤„:1,2ë²ˆì¤„ì´í•˜:1}')" title="{ë“¤ì—¬ì“°ê¸°,1ë²ˆì¤„:1,2ë²ˆì¤„ì´í•˜:1}"><span class="button-text">{ë“¤ì—¬ì“°ê¸°...}</span><small>[Alt+O]</small></button>
                <button class="group2" onclick="insertSyntax('{ë“¤ì—¬ì“°ê¸°,1ë²ˆì¤„:0,2ë²ˆì¤„ì´í•˜:0.5}')" title="{ë“¤ì—¬ì“°ê¸°,1ë²ˆì¤„:0,2ë²ˆì¤„ì´í•˜:0.5}"><span class="button-text">{ë“¤ì—¬ì“°ê¸°...}</span><small>[Alt+P]</small></button>
                <button class="group2" onclick="insertSyntax('{ë“¤ì—¬ì“°ê¸°,1ë²ˆì¤„:0.5,2ë²ˆì¤„ì´í•˜:1}')" title="{ë“¤ì—¬ì“°ê¸°,1ë²ˆì¤„:0.5,2ë²ˆì¤„ì´í•˜:1}"><span class="button-text">{ë“¤ì—¬ì“°ê¸°...}</span><small>[Alt+[ ]</small></button>
                <button class="group3" onclick="insertSyntax('{ì§„í•˜ê²Œ}')" title="{ì§„í•˜ê²Œ}"><span class="button-text">{ì§„í•˜ê²Œ}</span><small>[Alt+A]</small></button>
                <button class="group3" onclick="insertSyntax('{ë°‘ì¤„}')" title="{ë°‘ì¤„}"><span class="button-text">{ë°‘ì¤„}</span><small>[Alt+S]</small></button>
                <button class="group3" onclick="insertSyntax('{>>}')" title="{>>}"><span class="button-text">{>>}</span><small>[Alt+D]</small></button>
                <button class="group3" onclick="insertSyntax('{<<}')" title="{<<}"><span class="button-text">{<<}</span><small>[Alt+F]</small></button>
                <button class="group3" onclick="insertSyntax('{íƒ­}')" title="{íƒ­}"><span class="button-text">{íƒ­}</span><small>[Alt+G]</small></button>
                <button class="group3" onclick="insertSyntax('{ì¤„ë°”ê¿ˆ}')" title="{ì¤„ë°”ê¿ˆ}"><span class="button-text">{ì¤„ë°”ê¿ˆ}</span><small>[Alt+H]</small></button>
                <button class="group3" onclick="insertSyntax('{ë¬¸ë‹¨ë°”ê¿ˆ}')" title="{ë¬¸ë‹¨ë°”ê¿ˆ}"><span class="button-text">{ë¬¸ë‹¨ë°”ê¿ˆ}</span><small>[Alt+J]</small></button>
                <button class="group3" onclick="insertSyntax('{í˜ì´ì§€ë°”ê¿ˆ}')" title="{í˜ì´ì§€ë°”ê¿ˆ}"><span class="button-text">{í˜ì´ì§€ë°”ê¿ˆ}</span><small>[Alt+K]</small></button>
                <button class="group4" onclick="insertSyntax('{í‘œì‹œì‘1,ê¸€ê¼´=??,í¬ê¸°=#}')" title="{í‘œì‹œì‘1,ê¸€ê¼´=??,í¬ê¸°=#}"><span class="button-text">{í‘œì‹œì‘1...}</span><small>[Alt+Z]</small></button>
                <button class="group4" onclick="insertSyntax('{í‘œì‹œì‘1,í…Œë‘ë¦¬ì—†ìŒ}')" title="{í‘œì‹œì‘1,í…Œë‘ë¦¬ì—†ìŒ}"><span class="button-text">{í‘œì‹œì‘1,í…Œë‘ë¦¬ì—†ìŒ}</span><small>[Alt+X]</small></button>
                <button class="group4" onclick="insertSyntax('{í‘œë1}')" title="{í‘œë1}"><span class="button-text">{í‘œë1}</span><small>[Alt+C]</small></button>
                <button class="group4" onclick="insertSyntax('{í‘œì‹œì‘2,ê¸€ê¼´=??,í¬ê¸°=#}')" title="{í‘œì‹œì‘2,ê¸€ê¼´=??,í¬ê¸°=#}"><span class="button-text">{í‘œì‹œì‘2...}</span><small>[Alt+V]</small></button>
                <button class="group4" onclick="insertSyntax('{í‘œë2}')" title="{í‘œë2}"><span class="button-text">{í‘œë2}</span><small>[Alt+B]</small></button>
                <button class="group4" onclick="insertSyntax('{ì œëª©í–‰}')" title="{ì œëª©í–‰}"><span class="button-text">{ì œëª©í–‰}</span><small>[Alt+N]</small></button>
                <button class="group4" onclick="insertSyntax('{íšŒìƒ‰}')" title="{íšŒìƒ‰}"><span class="button-text">{íšŒìƒ‰}</span><small>[Alt+M]</small></button>
                <button class="group4" onclick="insertSyntax('{ë‚¨ìƒ‰}')" title="{ë‚¨ìƒ‰}"><span class="button-text">{ë‚¨ìƒ‰}</span><small>[Alt+,]</small></button>
                <button class="group5" onclick="insertSyntax('{ê·¸ë¦¼:~}')" title="{ê·¸ë¦¼:~}"><span class="button-text">{ê·¸ë¦¼:~}</span><small>[Alt+.]</small></button>
            </div>
        </div>
        <div class="section simple-find-replace-bar">
          <div class="find-replace-inputs">
            <label>ì°¾ê¸°: <input type="text" id="simpleFindText"></label>
            <label>ë°”ê¾¸ê¸°: <input type="text" id="simpleReplaceText"></label>
          </div>
          <div class="find-replace-buttons">
            <button class="syntax-button-like" onclick="simpleFindNext()">ë‹¤ìŒ ì°¾ê¸°</button>
            <button class="syntax-button-like" onclick="simpleReplaceCurrent()">ë°”ê¾¸ê¸°</button>
            <button class="syntax-button-like" onclick="previewSelectionBeforeReplaceAll()">ëª¨ë‘ ë°”ê¾¸ê¸°</button>
            <button class="syntax-button-like" onclick="performUndo()">ë˜ëŒë¦¬ê¸°</button> 
            <button class="syntax-button-like" onclick="resetFindReplace()">ì´ˆê¸°í™”</button>
          </div>
        </div>
        <div class="section main-editor-area">
          <textarea id="mainTextArea" placeholder="ì—¬ê¸°ëŠ” ë¬¸ì„œë¡œ ì‘ì„±í•  ë‚´ìš©ì„ ì…ë ¥í•˜ëŠ” ë¶€ë¶„ì…ë‹ˆë‹¤."></textarea>
        </div>
        <div class="section" style="flex-shrink: 1; flex-grow: 0; min-height: 100px; display: flex; flex-direction: column; ">
          <textarea id="memoTextArea" placeholder="ì—¬ê¸°ëŠ” ë³¸ë¬¸ ì‘ì„±ì‹œì— ì°¸ê³ í•  ë‚´ìš©ì„ ë©”ëª¨í•˜ëŠ” ë¶€ë¶„ì…ë‹ˆë‹¤.&#10;ë¬¸ì„œë¡œ ì‘ì„±ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤."></textarea>
        </div>
        <div class="action-buttons">
            <button class="open-drive" onclick="showCustomAlert('ì¤€ë¹„ ì¤‘ì¸ ê¸°ëŠ¥ì…ë‹ˆë‹¤.')">Google Drive</button>
            <button class="load-file" onclick="showCustomAlert('ì¤€ë¹„ ì¤‘ì¸ ê¸°ëŠ¥ì…ë‹ˆë‹¤.')">ë¶ˆëŸ¬ì˜¤ê¸°</button>
            <button class="save-draft" onclick="showCustomAlert('ì¤€ë¹„ ì¤‘ì¸ ê¸°ëŠ¥ì…ë‹ˆë‹¤.')">ì €ì¥<small style="font-weight: normal; margin-left: 3px;">[Ctrl+S]</small></button>
            <button class="create-doc" onclick="createWordClientSide()">ë¬¸ì„œì‘ì„±</button>
            <button class="delete-all" onclick="clearTextArea()">ì „ì²´ì‚­ì œ</button>
        </div>
      </div>
    `;
}

function getAiChatHtml() {
    return `
      <div class="chat-container">
        <div class="chat-messages">
          <div class="message message-assistant">
             <div class="message-content">ì•ˆë…•í•˜ì„¸ìš”! ë¬´ì—‡ì„ ë„ì™€ë“œë¦´ê¹Œìš”? íŒŒì¼ì„ ì—…ë¡œë“œí•˜ê±°ë‚˜, ì•„ë˜ ì…ë ¥ì°½ì— ì§ˆë¬¸ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.</div>
          </div>
        </div>
        <div class="chat-input-section">
          
          <div class="file-preview-container-wrapper">
            <div class="file-preview-container"></div>
          </div>

          <div class="chat-input-wrapper">
            <textarea class="message-input" placeholder="ì—¬ê¸°ì— ë©”ì‹œì§€ ì…ë ¥... (Shift+Enterë¡œ ì¤„ë°”ê¿ˆ)" rows="1"></textarea>
            <input type="file" class="file-input" multiple hidden accept="*/*">
            
            <div class="chat-button-group">
                <button class="chat-tool-btn upload-btn" title="íŒŒì¼ ì—…ë¡œë“œ">File</button>
                <button class="chat-tool-btn send-btn" title="ë³´ë‚´ê¸°">â¤</button>
            </div>
          </div>

        </div>
      </div>
    `;
}
    
// ==================================================================
// SECTION 2: UI ë¡œì§ ë° í•µì‹¬ ê¸°ëŠ¥ í•¨ìˆ˜
// ==================================================================

// --- UI í”¼ë“œë°± í•¨ìˆ˜ (íŒì—…, ë¡œë”©) ---
function showLoadingPopup() { if (!loadingPopup) return; loadingPopup.style.display = 'flex'; loadingStartTime = Date.now(); const timeDisplay = document.getElementById('loadingTimeElapsed'); if (timeDisplay) timeDisplay.textContent = '[0.00 Sec]'; if (loadingTimerIntervalId) clearInterval(loadingTimerIntervalId); loadingTimerIntervalId = setInterval(() => { const elapsedTimeMs = Date.now() - loadingStartTime; if (timeDisplay) timeDisplay.textContent = `[${(elapsedTimeMs / 1000).toFixed(2)} Sec]`; }, 100); }
function hideLoadingPopup() { if (!loadingPopup) return; loadingPopup.style.display = 'none'; if (loadingTimerIntervalId) { clearInterval(loadingTimerIntervalId); loadingTimerIntervalId = null; } }
function showCustomAlert(message) { const popup = document.getElementById('customAlert'); const messageEl = document.getElementById('customAlertMessage'); const okButton = document.getElementById('customAlertOkButton'); if (!popup || !messageEl || !okButton) return; messageEl.textContent = message; popup.style.display = 'flex'; okButton.onclick = () => popup.style.display = 'none'; }
function showCustomConfirm(message) { const popup = document.getElementById('customConfirm'); const messageEl = document.getElementById('customConfirmMessage'); const okButton = document.getElementById('customConfirmOkButton'); const cancelButton = document.getElementById('customConfirmCancelButton'); if (!popup || !messageEl || !okButton || !cancelButton) return Promise.reject(); return new Promise((resolve, reject) => { messageEl.textContent = message; popup.style.display = 'flex'; okButton.onclick = () => { popup.style.display = 'none'; resolve(true); }; cancelButton.onclick = () => { popup.style.display = 'none'; reject(false); }; }); }

// --- í•µì‹¬ í¸ì§‘ ê¸°ëŠ¥ ---
function createDocument() { if (!mainTextArea) return; showLoadingPopup(); let docTitle = docTitleInput.value.trim(); if (!docTitle) { docTitle = generateFilename('[ì‘ì„±]'); } const settings = { fontFamily: fontFamilySelect.value, fontSize: fontSizeInput.value, lineSpacing: lineSpacingInput.value, paraSpacingAfter: paraSpacingAfterInput.value, pageOrientation: document.getElementById('pageOrientation').value, marginTop: marginTopInput.value, marginBottom: marginBottomInput.value, marginLeft: marginLeftInput.value, marginRight: marginRightInput.value }; const payload = { content: mainTextArea.value, memoContent: memoTextArea.value }; google.script.run.withSuccessHandler(onCreateDocSuccess).withFailureHandler(onFailure).createDocumentInDrive(payload, docTitle, settings); }
function saveDraft() { if (!mainTextArea) return; showLoadingPopup(); let docTitle = docTitleInput.value.trim(); if (!docTitle) { docTitle = generateFilename('[ì €ì¥]'); } const settings = { fontFamily: fontFamilySelect.value, fontSize: fontSizeInput.value, lineSpacing: lineSpacingInput.value, paraSpacingAfter: paraSpacingAfterInput.value, pageOrientation: document.getElementById('pageOrientation').value, marginTop: marginTopInput.value, marginBottom: marginBottomInput.value, marginLeft: marginLeftInput.value, marginRight: marginRightInput.value }; const payload = { content: mainTextArea.value, memoContent: memoTextArea.value, settings: settings }; google.script.run.withSuccessHandler(message => { hideLoadingPopup(); showCustomAlert(message); }).withFailureHandler(onFailure).saveDraftToServer(payload, docTitle); }
async function clearTextArea() { if (!mainTextArea) return; try { await showCustomConfirm('ë¬¸ì„œ ì œëª©, ë‚´ìš©, ë©”ëª¨ë¥¼ ì „ì²´ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?'); mainTextArea.value = ''; memoTextArea.value = ''; docTitleInput.value = ''; showCustomAlert('ì œëª©, ë‚´ìš©, ë©”ëª¨ê°€ ëª¨ë‘ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.'); } catch (error) { console.log('ì‚­ì œ ì·¨ì†Œ'); } }

// --- ì°¾ê¸°/ë°”ê¾¸ê¸° ë° ì‹¤í–‰ ì·¨ì†Œ ---
function simpleFindNext() { if (!mainTextArea) return; const term = document.getElementById('simpleFindText').value; if (!term) { showCustomAlert('ì°¾ì„ ë‹¨ì–´ë¥¼ ì…ë ¥í•˜ì„¸ìš”.'); return; } let searchStartIndex = mainTextArea.selectionEnd; let foundIndex = mainTextArea.value.indexOf(term, searchStartIndex); if (foundIndex === -1) { const wrapAroundIndex = mainTextArea.value.indexOf(term, 0); if (wrapAroundIndex === -1 || wrapAroundIndex === mainTextArea.selectionStart) { showCustomAlert('"' + term + '" ì„(ë¥¼) ë¬¸ì„œì—ì„œ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.'); return; } foundIndex = wrapAroundIndex; } mainTextArea.focus(); mainTextArea.setSelectionRange(foundIndex, foundIndex + term.length); }
function simpleReplaceCurrent() { if (!mainTextArea) return; const term = document.getElementById('simpleFindText').value; const replacement = document.getElementById('simpleReplaceText').value; const start = mainTextArea.selectionStart; const end = mainTextArea.selectionEnd; if (start === end || mainTextArea.value.substring(start, end) !== term) { simpleFindNext(); return; } undoStack.push({ value: mainTextArea.value, selectionStart: start, selectionEnd: end }); const before = mainTextArea.value.substring(0, start); const after = mainTextArea.value.substring(end); mainTextArea.value = before + replacement + after; mainTextArea.setSelectionRange(start, start + replacement.length); simpleFindNext(); }
async function previewSelectionBeforeReplaceAll() { if (!mainTextArea) return; const term = document.getElementById('simpleFindText').value; const replacement = document.getElementById('simpleReplaceText').value; if (!term) { showCustomAlert("ì°¾ì„ ë‹¨ì–´ë¥¼ ì…ë ¥í•˜ì„¸ìš”."); return; } const start = mainTextArea.selectionStart; const end = mainTextArea.selectionEnd; const scope = (start !== end) ? "ì„ íƒëœ ì˜ì—­" : "ì „ì²´ ë¬¸ì„œ"; try { await showCustomConfirm(`'${term}' ì„(ë¥¼) '${replacement}' (ìœ¼)ë¡œ ${scope}ì—ì„œ ëª¨ë‘ ë°”ê¾¸ì‹œê² ìŠµë‹ˆê¹Œ?`); undoStack.push({ value: mainTextArea.value, selectionStart: start, selectionEnd: end }); let count = 0; const regex = new RegExp(term.replace(/[.*+?^${}()|[\]\\]/g, '\\$&'), 'g'); if (scope === "ì„ íƒëœ ì˜ì—­") { const before = mainTextArea.value.substring(0, start); const selected = mainTextArea.value.substring(start, end); const after = mainTextArea.value.substring(end); const replacedText = selected.replace(regex, () => { count++; return replacement; }); mainTextArea.value = before + replacedText + after; mainTextArea.setSelectionRange(start, start + replacedText.length); } else { mainTextArea.value = mainTextArea.value.replace(regex, () => { count++; return replacement; }); } showCustomAlert(`ì´ ${count}ê°œë¥¼ ë°”ê¿¨ìŠµë‹ˆë‹¤.`); } catch (error) { console.log('ëª¨ë‘ ë°”ê¾¸ê¸° ì·¨ì†Œ'); } }
function resetFindReplace() { if (!mainTextArea) return; document.getElementById('simpleFindText').value = ''; document.getElementById('simpleReplaceText').value = ''; mainTextArea.focus(); }
function performUndo() { if (undoStack.length > 0) { const previous = undoStack.pop(); mainTextArea.value = previous.value; mainTextArea.setSelectionRange(previous.selectionStart, previous.selectionEnd); mainTextArea.focus(); } }

// ==================================================================
// SECTION 2.5: Google ì¸ì¦ ë° ë°ì´í„° ê´€ë¦¬ (ì‹ ê·œ ì¶”ê°€)
// ==================================================================

function gisLoaded() {
    tokenClient = google.accounts.oauth2.initTokenClient({
        client_id: CLIENT_ID,
        scope: SCOPES,
        callback: async (tokenResponse) => {
            if (tokenResponse && tokenResponse.access_token) {
                googleUser = { isSignedIn: () => true };
                updateLoginUI(true);
                await loadAndApplySessionData();
            } else {
                console.log("ë¡œê·¸ì¸ ì ˆì°¨ê°€ ì™„ë£Œë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.");
                // ì‚¬ìš©ìê°€ íŒì—…ì„ ë‹«ìœ¼ë©´ ë‹¤ì‹œ ë¡œê·¸ì¸ ì‹œë„
                handleAuthClick(); 
            }
        },
    });

    gapi.load('client', () => {
        gapi.client.init({
            discoveryDocs: ['https://www.googleapis.com/discovery/v1/apis/drive/v3/rest'],
        }).then(() => {
            isGapiReady = true; // êµ¬ê¸€ API ì¤€ë¹„ ì™„ë£Œ ìƒíƒœë¡œ ë³€ê²½
            initializeApp();    // ì•± ì´ˆê¸°í™” ì‹œë„
        });
    });
} 
    
// [ì‚­ì œ] gapiLoaded í•¨ìˆ˜ëŠ” ë” ì´ìƒ í•„ìš” ì—†ìœ¼ë¯€ë¡œ ì‚­ì œí•©ë‹ˆë‹¤.
// <script src="...api.js" onload="gapiLoaded()"> ë¶€ë¶„ë„ onloadë¥¼ ì§€ìš°ê³  srcë§Œ ë‚¨ê¹ë‹ˆë‹¤.
// ìˆ˜ì • -> <script async defer src="https://apis.google.com/js/api.js"></script>
// (ë‹¨, ì´ ë¶€ë¶„ ìˆ˜ì •ì´ ì–´ë ¤ìš°ë©´ ê·¸ëƒ¥ ë‘ì…”ë„ í° ë¬¸ì œëŠ” ì—†ìŠµë‹ˆë‹¤.)

// [êµì²´] ë¡œê·¸ì¸ ë²„íŠ¼ í´ë¦­ í•¸ë“¤ëŸ¬
function handleAuthClick() {
    tokenClient.requestAccessToken({ prompt: 'consent' });
}    

async function handleSignoutClick() {
Â  Â  // ë¡œê·¸ì•„ì›ƒ ì „ ë§ˆì§€ë§‰ ìƒíƒœë¥¼ Driveì— ì €ì¥í•©ë‹ˆë‹¤.
Â  Â  await updateAndSaveSession(); 
Â  Â  
Â  Â  const token = gapi.client.getToken();
Â  Â  if (token !== null) {
Â  Â  Â  Â  google.accounts.oauth2.revoke(token.access_token, () => {
Â  Â  Â  Â  Â  Â  gapi.client.setToken('');
Â  Â  Â  Â  Â  Â  // ë¡œê·¸ì•„ì›ƒ ìƒíƒœë¡œ ë³€ê²½
Â  Â  Â  Â  Â  Â  googleUser = { isSignedIn: () => false };
Â  Â  Â  Â  Â  Â  updateLoginUI(false);
Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  // ì „ì—­ ì„¸ì…˜ ë°ì´í„°ì™€ ì—ë””í„° ë‚´ìš©ì„ ì´ˆê¸°í™”í•©ë‹ˆë‹¤.
Â  Â  Â  Â  Â  Â  currentSessionData = {};
Â  Â  Â  Â  Â  Â  if(mainTextArea) mainTextArea.value = '';
Â  Â  Â  Â  Â  Â  if(memoTextArea) memoTextArea.value = '';
Â  Â  Â  Â  Â  Â  if(docTitleInput) docTitleInput.value = '';

Â  Â  Â  Â  Â  Â  showCustomAlert('ë¡œê·¸ì•„ì›ƒ ë˜ì—ˆìŠµë‹ˆë‹¤.');

            // ë¡œê·¸ì•„ì›ƒ í›„ ë‹¤ì‹œ ë¡œê·¸ì¸ ì°½ì„ ë„ì›ë‹ˆë‹¤.
            handleAuthClick();
    
Â  Â  Â  Â  });
Â  Â  }
}

function updateLoginUI(isSignedIn) {
    document.getElementById('google-sign-in-button').style.display = isSignedIn ? 'none' : 'inline-block';
    document.getElementById('google-sign-out-button').style.display = isSignedIn ? 'inline-block' : 'none';
}
    
// --- ë°ì´í„° ìº¡ì²˜, ì €ì¥, ë¡œë“œ ---

// [êµì²´] captureCurrentState - ëª¨ë“  íƒ­ì˜ ìƒíƒœë¥¼ ì €ì¥
function captureCurrentState() {
    const components = {};
    document.querySelectorAll('.content-column').forEach(column => {
        const componentId = column.classList[1]; // e.g., 'Section2-1'
        const tabsData = [];
        
        column.querySelectorAll('.tab-content-pane').forEach(pane => {
            const tabId = pane.dataset.tabId;
            const tabElement = column.querySelector(`.tab[data-tab-id="${tabId}"] span:first-of-type`);
            const tabName = tabElement ? tabElement.textContent : 'tab';
            
            let content = {};
            if (componentId === 'Section2-3') { // Editor
                content = {
                    docTitle: pane.querySelector('#docTitle')?.value,
                    mainContent: pane.querySelector('#mainTextArea')?.value,
                    memoContent: pane.querySelector('#memoTextArea')?.value,
                };
            } else if (componentId === 'Section2-2') { // AI Chat
                const messages = [];
                pane.querySelectorAll('.chat-messages .message').forEach(msgEl => {
                    const sender = msgEl.classList.contains('message-user') ? 'user' : 'assistant';
                    const text = msgEl.querySelector('.message-content')?.innerText;
                    if(text) messages.push({ sender, text });
                });
                content = { messages };
            }
            // Section2-1 (Prompter) ë“± ë‹¤ë¥¸ ì»´í¬ë„ŒíŠ¸ ë°ì´í„°ë„ ê°™ì€ ë°©ì‹ìœ¼ë¡œ ì¶”ê°€ ê°€ëŠ¥
            
            tabsData.push({ id: tabId, name: tabName, content });
        });
        components[componentId] = { tabs: tabsData };
    });
    currentSessionData = { components };
}
    
async function updateAndSaveSession() {
    // 1. ë¡œê·¸ì¸ ìƒíƒœì¸ì§€ ë¨¼ì € í™•ì¸í•©ë‹ˆë‹¤.
Â  Â  if (!googleUser.isSignedIn()) {
Â  Â  Â  Â  return; // ë¡œê·¸ì•„ì›ƒ ìƒíƒœì´ë©´ ì•„ë¬´ê²ƒë„ í•˜ì§€ ì•Šê³  í•¨ìˆ˜ë¥¼ ì¢…ë£Œí•©ë‹ˆë‹¤.
Â  Â  }
    
    // 2. í˜„ì¬ í˜ì´ì§€ì˜ ìƒíƒœë¥¼ ìº¡ì²˜í•©ë‹ˆë‹¤.
Â  Â  captureCurrentState();

    // 3. Google Driveì— ì €ì¥í•©ë‹ˆë‹¤.
Â  Â  try {
Â  Â  Â  Â  await saveSessionDataToDrive(currentSessionData);
Â  Â  } catch (e) {
Â  Â  Â  Â  console.error('Google Drive ìë™ ì €ì¥ ì‹¤íŒ¨:', e);
Â  Â  }
}

// [ìˆ˜ì •] getDriveAssetIds - FOLDER_NAME ì „ì—­ ë³€ìˆ˜ ì‚¬ìš©
async function getDriveAssetIds() {
    const FOLDER_NAME = 'SRAIEditor';
    let folderId = null;
    let response = await gapi.client.drive.files.list({
        q: `mimeType='application/vnd.google-apps.folder' and name='${FOLDER_NAME}' and trashed=false`,
        fields: 'files(id)',
        spaces: 'drive'
    });
    if (response.result.files && response.result.files.length > 0) {
        folderId = response.result.files[0].id;
    } else {
        const folderMetadata = { name: FOLDER_NAME, mimeType: 'application/vnd.google-apps.folder' };
        response = await gapi.client.drive.files.create({ resource: folderMetadata, fields: 'id' });
        folderId = response.result.id;
    }
    if (!folderId) throw new Error('SRAIEditor í´ë”ë¥¼ ì°¾ê±°ë‚˜ ìƒì„±í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');

    response = await gapi.client.drive.files.list({
        q: `name='${SESSION_DATA_FILE_NAME}' and '${folderId}' in parents and trashed=false`,
        fields: 'files(id)',
        spaces: 'drive'
    });
    const fileId = response.result.files?.[0]?.id || null;
    return { folderId, fileId };
}

/**
 * [êµì²´ë¨] í˜„ì¬ ì„¸ì…˜ ë°ì´í„°ë¥¼ Google Driveì˜ 'SRAIEditor' í´ë”ì— ì €ì¥í•©ë‹ˆë‹¤.
 * @param {object} data - ì €ì¥í•  ì„¸ì…˜ ë°ì´í„°
 */
async function saveSessionDataToDrive(data) {
    const { folderId, fileId } = await getDriveAssetIds();
    const blob = new Blob([JSON.stringify(data)], { type: 'application/json' });

    const form = new FormData();
    const fileMetadata = { name: SESSION_DATA_FILE_NAME };

    // ìƒˆ íŒŒì¼ì¸ ê²½ìš°ì—ë§Œ ë¶€ëª¨ í´ë”ë¥¼ ì§€ì •í•©ë‹ˆë‹¤.
    if (!fileId) {
        fileMetadata.parents = [folderId];
    }

    form.append('metadata', new Blob([JSON.stringify(fileMetadata)], { type: 'application/json' }));
    form.append('file', blob);

    const path = fileId
        ? `https://www.googleapis.com/upload/drive/v3/files/${fileId}?uploadType=multipart`
        : 'https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart';

    await gapi.client.request({
        path: path,
        method: fileId ? 'PATCH' : 'POST',
        body: form,
    });
}

// [êµì²´] loadAndApplySessionData - ì €ì¥ëœ ìƒíƒœë¡œë¶€í„° ì „ì²´ UI ë³µì›
async function loadAndApplySessionData() {
    if (!googleUser.isSignedIn()) return;

    showLoadingPopup();
    let loadedData = null;

    try {
        const { fileId } = await getDriveAssetIds();
        if (fileId) {
            const response = await gapi.client.drive.files.get({ fileId: fileId, alt: 'media' });
            loadedData = response.result;
        }
    } catch (e) {
        console.error('Drive ë°ì´í„° ë¡œë“œ ì˜¤ë¥˜:', e);
        showCustomAlert('ë°ì´í„° ë¡œë“œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
    } finally {
        hideLoadingPopup();
    }

    if (loadedData && loadedData.components) {
        // ëª¨ë“  ì»´í¬ë„ŒíŠ¸(ì»¬ëŸ¼)ì— ëŒ€í•´ ë£¨í”„ ì‹¤í–‰
        for (const componentId in loadedData.components) {
            const column = document.querySelector(`.${componentId}`);
            if (!column) continue;

            const tabData = loadedData.components[componentId].tabs;
            const tabContentArea = column.querySelector('.tab-content-area');
            const tabList = column.querySelector('.tab-list');
            const addButton = column.querySelector('.add-tab-btn');

            // ê¸°ì¡´ íƒ­ ëª¨ë‘ ì‚­ì œ
            tabContentArea.innerHTML = '';
            tabList.innerHTML = '';

            if (tabData.length === 0) { // ì €ì¥ëœ íƒ­ì´ ì—†ìœ¼ë©´ ê¸°ë³¸ íƒ­ í•˜ë‚˜ ìƒì„±
                 addButton.click();
            } else {
                 for (const tab of tabData) {
                    addButton.click(); // ìƒˆ íƒ­ ì¶”ê°€
                    const newPane = column.querySelector('.tab-content-pane:last-child');
                    const newTab = column.querySelector('.tab:last-child');
                    
                    // íƒ­ ì´ë¦„ ì„¤ì •
                    newTab.querySelector('span:first-of-type').textContent = tab.name;

                    // íƒ­ ì½˜í…ì¸  ì±„ìš°ê¸°
                    if (componentId === 'Section2-3') { // Editor
                        newPane.querySelector('#docTitle').value = tab.content.docTitle || '';
                        newPane.querySelector('#mainTextArea').value = tab.content.mainContent || '';
                        newPane.querySelector('#memoTextArea').value = tab.content.memoContent || '';
                    } else if (componentId === 'Section2-2') { // AI Chat
                        const messagesContainer = newPane.querySelector('.chat-messages');
                        messagesContainer.innerHTML = ''; // ê¸°ë³¸ ë©”ì‹œì§€ ì‚­ì œ
                        tab.content.messages.forEach(msg => {
                            const msgDiv = document.createElement('div');
                            msgDiv.className = `message message-${msg.sender}`;
                            msgDiv.innerHTML = `<div class="message-wrapper"><div class="message-content">${msg.text.replace(/\n/g, '<br>')}</div><button class="copy-btn" title="ë‚´ìš© ë³µì‚¬">ğŸ“‹</button></div>`;
                            msgDiv.querySelector('.copy-btn').addEventListener('click', () => navigator.clipboard.writeText(msg.text));
                            messagesContainer.appendChild(msgDiv);
                        });
                    }
                 }
            }
            // ì²« ë²ˆì§¸ íƒ­ì„ í™œì„±í™” ìƒíƒœë¡œ ë§Œë“¦
            const firstTab = column.querySelector('.tab');
            if(firstTab) firstTab.click();
        }
        showCustomAlert('Google Driveì—ì„œ ì§ì „ ì‘ì—… ë‚´ìš©ì„ ë¶ˆëŸ¬ì™”ìŠµë‹ˆë‹¤.');
    }

    startAutoSaveTimer();
}


     
// --- ìë™ ì €ì¥ íƒ€ì´ë¨¸ ---
function startAutoSaveTimer() {
    if (autoSaveTimerIntervalId) clearInterval(autoSaveTimerIntervalId);
    autoSaveTimerIntervalId = setInterval(updateAndSaveSession, AUTO_SAVE_INTERVAL);
}
    
    
// --- ìœ í‹¸ë¦¬í‹° ë° ë³´ì¡° í•¨ìˆ˜ ---
function generateFilename(prefix) { const now = new Date(); const yymmdd = now.getFullYear().toString().slice(-2) + (now.getMonth() + 1).toString().padStart(2, '0') + now.getDate().toString().padStart(2, '0'); const hhmmss = now.getHours().toString().padStart(2, '0') + now.getMinutes().toString().padStart(2, '0') + now.getSeconds().toString().padStart(2, '0'); return `${prefix}ì œëª©ì—†ìŒ_${yymmdd}_T${hhmmss}`; }
function insertSyntax(syntax) { if (!mainTextArea) return; const { scrollTop, selectionStart, selectionEnd, value } = mainTextArea; mainTextArea.value = value.substring(0, selectionStart) + syntax + value.substring(selectionEnd); mainTextArea.focus(); mainTextArea.selectionStart = mainTextArea.selectionEnd = selectionStart + syntax.length; mainTextArea.scrollTop = scrollTop; }
function handleContextScroll(isScrollingDown) { if (!mainTextArea) return; const computedStyle = window.getComputedStyle(mainTextArea); const lineHeight = parseFloat(computedStyle.lineHeight); const scrollAmount = mainTextArea.clientHeight - (3 * lineHeight); let newScrollTop = isScrollingDown ? mainTextArea.scrollTop + scrollAmount : mainTextArea.scrollTop - scrollAmount; mainTextArea.scrollTo({ top: newScrollTop, behavior: 'smooth' }); }
async function createWordClientSide() {
    showLoadingPopup();
    const title = docTitleInput.value.trim();
    const content = mainTextArea.value;
    const settings = {
        font_family_east_asia: fontFamilySelect.value,
        font_size: parseFloat(fontSizeInput.value) || 12,
        line_spacing: parseFloat(lineSpacingInput.value) || 1.5,
        para_spacing_after: parseFloat(paraSpacingAfterInput.value) || 10,
        page_orientation: document.getElementById('pageOrientation').value,
        margin_top: parseFloat(marginTopInput.value) || 2.0,
        margin_bottom: parseFloat(marginBottomInput.value) || 2.0,
        margin_left: parseFloat(marginLeftInput.value) || 2.5,
        margin_right: parseFloat(marginRightInput.value) || 2.5,
    };
    try {
        const BACKEND_URL = "https://sraieditor20250711-983424591109.asia-northeast3.run.app";
        const response = await fetch(`${BACKEND_URL}/create-docx`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', },
            body: JSON.stringify({ content: content, settings: settings, title: title }),
        });
        hideLoadingPopup();
        if (response.ok) {
            const blob = await response.blob();
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.style.display = 'none';
            a.href = url;
            let fileName = title ? `${title}.docx` : 'generated_document.docx';
            a.download = fileName;
            document.body.appendChild(a);
            a.click();
            window.URL.revokeObjectURL(url);
            a.remove();
            showCustomAlert(`'${fileName}' íŒŒì¼ ë‹¤ìš´ë¡œë“œê°€ ì‹œì‘ë©ë‹ˆë‹¤.`);
        } else {
            const error = await response.json();
            showCustomAlert('íŒŒì¼ ìƒì„± ì¤‘ ì˜¤ë¥˜ ë°œìƒ: ' + error.error);
        }
    } catch (error) {
        hideLoadingPopup();
        console.error('Error:', error);
        showCustomAlert('ë°±ì—”ë“œ ì„œë²„ì— ì—°ê²°í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
    }
}


// ==================================================================
// SECTION 3: íƒ­ ì»´í¬ë„ŒíŠ¸ ê´€ë¦¬ í•¨ìˆ˜
// ==================================================================

/**
 * [ì—…ê·¸ë ˆì´ë“œ ë²„ì „] ë²”ìš© íƒ­ ì»´í¬ë„ŒíŠ¸ ìƒì„± í•¨ìˆ˜
 */
function createTabComponent(targetSelector, title, initialContentHtml, onTabActivated) {
    const container = document.querySelector(targetSelector);
    if (!container) {
        console.error(targetSelector + ' ìš”ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
        return;
    }
    container.innerHTML = `<div style="padding: 5px 0 0 5px; font-weight: 600;"><span>${title}</span></div><div class="tab-content-area"><div class="tab-content-pane active" data-tab-id="tab1">${initialContentHtml}</div></div><div class="tab-bar"><div class="tab-nav-start"><div class="tab-nav-button tab-scroll-btn" data-direction="-1">â—€</div></div><div class="tab-list"><div class="tab active" data-tab-id="tab1"><span>tab1</span><span class="close-tab">Ã—</span></div></div><div class="tab-controls"><div class="tab-nav-button add-tab-btn">+</div><div class="tab-nav-button tab-scroll-btn" data-direction="1">â–¶</div></div></div>`;
    
    const tabList = container.querySelector('.tab-list');
    const tabContentArea = container.querySelector('.tab-content-area');
    const addButton = container.querySelector('.add-tab-btn');
    let tabCounter = 1;

    function activateTab(tabToActivate) {
        if (!tabToActivate) return;
        tabList.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        tabContentArea.querySelectorAll('.tab-content-pane').forEach(p => p.classList.remove('active'));
        tabToActivate.classList.add('active');
        const correspondingPane = tabContentArea.querySelector(`[data-tab-id="${tabToActivate.dataset.tabId}"]`);
        if (correspondingPane) {
            correspondingPane.classList.add('active');
            if (onTabActivated && typeof onTabActivated === 'function') {
                onTabActivated(correspondingPane);
            }
        }
    }
    
    addButton.addEventListener('click', () => {
        tabCounter++;
        const newTabId = `tab${tabCounter}`;
        const newTab = document.createElement('div');
        newTab.className = 'tab';
        newTab.dataset.tabId = newTabId;
        newTab.innerHTML = `<span>${newTabId}</span><span class="close-tab">Ã—</span>`;
        
        const newPane = document.createElement('div');
        newPane.className = 'tab-content-pane';
        newPane.dataset.tabId = newTabId;
        
        // Editorì™€ PrompterëŠ” ì„œë¡œ ë‹¤ë¥¸ ë‚´ìš©ì„ ê°€ì§ˆ ìˆ˜ ìˆìœ¼ë¯€ë¡œ, initialContentHtmlì„ ê¸°ë°˜ìœ¼ë¡œ ìƒˆ íƒ­ì„ ë§Œë“­ë‹ˆë‹¤.
        // ì—¬ê¸°ì„œëŠ” ê°„ë‹¨í•˜ê²Œ Editorì˜ HTMLì„ ì¬ì‚¬ìš©í•˜ëŠ” ê²ƒìœ¼ë¡œ ê°€ì •í•©ë‹ˆë‹¤. ë” ë³µì¡í•œ ë¡œì§ì´ í•„ìš”í•˜ë©´ ìˆ˜ì •ì´ í•„ìš”í•©ë‹ˆë‹¤.
        if (container.classList.contains('Section2-3')) {
            newPane.innerHTML = getEditorHtml();
        } else {
             newPane.innerHTML = getPrompterListHtml();
        }


        tabList.appendChild(newTab);
        tabContentArea.appendChild(newPane);
        activateTab(newTab);
        tabList.scrollLeft = tabList.scrollWidth;
    });

    tabList.addEventListener('click', (event) => {
        const target = event.target;
        if (target.classList.contains('close-tab')) {
            event.stopPropagation();
            const tabToRemove = target.closest('.tab');
            if (tabList.querySelectorAll('.tab').length === 1) { return showCustomAlert('ë§ˆì§€ë§‰ íƒ­ì€ ë‹«ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.'); }
            
            let nextTabToActivate = null;
            if (tabToRemove.classList.contains('active')) {
                nextTabToActivate = tabToRemove.previousElementSibling || tabToRemove.nextElementSibling;
            }
            const paneToRemove = tabContentArea.querySelector(`[data-tab-id="${tabToRemove.dataset.tabId}"]`);
            tabToRemove.remove();
            if(paneToRemove) paneToRemove.remove();
            
            if (nextTabToActivate) {
                activateTab(nextTabToActivate);
            }
            return;
        }
        const clickedTab = target.closest('.tab');
        if (clickedTab && !clickedTab.classList.contains('active')) {
            activateTab(clickedTab);
        }
    });

    tabList.addEventListener('dblclick', (event) => {
        const target = event.target;
        if (!target.matches('.tab > span:first-of-type')) { return; }
        const currentSpan = target;
        const currentName = currentSpan.textContent;
        const tempInput = document.createElement('input');
        tempInput.type = 'text';
        tempInput.value = currentName;
        tempInput.className = 'tab-edit-input';
        currentSpan.style.display = 'none';
        currentSpan.after(tempInput);
        tempInput.focus();
        tempInput.select();
        const finishEditing = () => {
            let newName = tempInput.value.trim();
            if (!newName) {
                currentSpan.textContent = currentName;
            } else {
                const otherTabSpans = [...tabList.querySelectorAll('.tab > span:first-of-type')].filter(span => span !== currentSpan);
                const existingNames = otherTabSpans.map(span => span.textContent);
                let finalName = newName;
                let counter = 2;
                while (existingNames.includes(finalName)) {
                    finalName = `${newName} (${counter})`;
                    counter++;
                }
                currentSpan.textContent = finalName;
            }
            tempInput.remove();
            currentSpan.style.display = '';
        };
        tempInput.addEventListener('blur', finishEditing);
        tempInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter') finishEditing();
        });
    });
    
    container.querySelectorAll('.tab-scroll-btn').forEach(button => {
        button.addEventListener('click', () => {
            const direction = parseInt(button.dataset.direction, 10);
            const scrollAmount = 200;
            tabList.scrollBy({ left: scrollAmount * direction, behavior: 'smooth' });
        });
    });

    activateTab(container.querySelector('.tab.active'));
}

/**
 * AI ì±„íŒ… ì»´í¬ë„ŒíŠ¸ì˜ ëª¨ë“  ë¡œì§ì„ ê´€ë¦¬í•˜ëŠ” ë…ë¦½ í•¨ìˆ˜ (ìµœì¢… ì™„ì„±ë³¸)
 */
function initializeAiChatComponent(targetSelector, title) {
    const container = document.querySelector(targetSelector);
    if (!container) return;
    const initialContentHtml = getAiChatHtml();
    container.innerHTML = `<div style="padding: 5px 0 0 5px; font-weight: 600;"><span>${title}</span></div><div class="tab-content-area"><div class="tab-content-pane active" data-tab-id="tab1">${initialContentHtml}</div></div><div class="tab-bar"><div class="tab-nav-start"><div class="tab-nav-button tab-scroll-btn" data-direction="-1">â—€</div></div><div class="tab-list"><div class="tab active" data-tab-id="tab1"><span>tab1</span><span class="close-tab">Ã—</span></div></div><div class="tab-controls"><div class="tab-nav-button add-tab-btn">+</div><div class="tab-nav-button tab-scroll-btn" data-direction="1">â–¶</div></div></div>`;

    const tabList = container.querySelector('.tab-list');
    const tabContentArea = container.querySelector('.tab-content-area');
    const addButton = container.querySelector('.add-tab-btn');
    let tabCounter = 1;

    // ê°œë³„ ì±„íŒ… íƒ­ì˜ ëª¨ë“  ê¸°ëŠ¥ì„ ì„¤ì •í•˜ëŠ” í•¨ìˆ˜
    const setupChatPane = (chatPane) => {
        if (chatPane.dataset.chatInitialized) return;

        const messagesContainer = chatPane.querySelector('.chat-messages');
        const messageInput = chatPane.querySelector('.message-input');
        const sendButton = chatPane.querySelector('.send-btn');
        const uploadButton = chatPane.querySelector('.upload-btn');
        const fileInput = chatPane.querySelector('.file-input');
        const filePreviewContainer = chatPane.querySelector('.file-preview-container');
        let uploadedFiles = [];

        // ë©”ì‹œì§€ ì „ì†¡ ë¡œì§
        const sendMessage = async () => { // async í‚¤ì›Œë“œê°€ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤.
            const messageText = messageInput.value.trim();
            if (messageText === '' && uploadedFiles.length === 0) return;
        
            // --- ì‚¬ìš©ì ë©”ì‹œì§€ í‘œì‹œ (ì´ ë¶€ë¶„ì€ ê¸°ì¡´ ì½”ë“œì™€ ë™ì¼) ---
            const userMessageDiv = document.createElement('div');
            userMessageDiv.className = 'message message-user';
            let messageHTML = '';
            let contentToCopy = messageText;
            if (uploadedFiles.length > 0) {
                const filesText = uploadedFiles.map(f => `- ${f.name}`).join('\n');
                contentToCopy = `${filesText}\n${messageText}`;
                const filesHTML = uploadedFiles.map(file => `<div>- ${file.name}</div>`).join('');
                messageHTML = `<div class="message-content">${filesHTML}<br>${messageText.replace(/\n/g, '<br>')}</div>`;
            } else {
                messageHTML = `<div class="message-content">${messageText.replace(/\n/g, '<br>')}</div>`;
            }
            userMessageDiv.innerHTML = `<div class="message-wrapper">${messageHTML}<button class="copy-btn" title="ë‚´ìš© ë³µì‚¬">ğŸ“‹</button></div>`;
            userMessageDiv.querySelector('.copy-btn').addEventListener('click', () => {
                navigator.clipboard.writeText(contentToCopy).catch(err => console.error('ë³µì‚¬ ì‹¤íŒ¨: ', err));
            });
            messagesContainer.appendChild(userMessageDiv);
        
            // ì…ë ¥ì°½ ë° íŒŒì¼ ì´ˆê¸°í™”
            messageInput.value = '';
            messageInput.style.height = 'auto';
            filePreviewContainer.innerHTML = '';
            const currentFiles = [...uploadedFiles];
            uploadedFiles = [];
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
            
            // --- AI ì‘ë‹µ ì²˜ë¦¬ (setTimeout ë¶€ë¶„ì„ ì‹¤ì œ API í˜¸ì¶œë¡œ ë³€ê²½) ---
        
            // 1. "ë‹µë³€ ìƒì„± ì¤‘..." ì„ì‹œ ë©”ì‹œì§€ë¥¼ ë¨¼ì € í‘œì‹œí•©ë‹ˆë‹¤.
            const loadingMessageDiv = document.createElement('div');
            loadingMessageDiv.className = 'message message-assistant';
            loadingMessageDiv.innerHTML = `<div class="message-wrapper"><div class="message-content">ë‹µë³€ ìƒì„± ì¤‘...</div></div>`;
            messagesContainer.appendChild(loadingMessageDiv);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        
            try {
                // 2. ë°±ì—”ë“œ APIë¥¼ í˜¸ì¶œí•©ë‹ˆë‹¤.
                const BACKEND_URL = "https://sraieditor20250711-983424591109.asia-northeast3.run.app";
                
                const response = await fetch(`${BACKEND_URL}/chat-gemini`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ message: messageText }), // ì‚¬ìš©ì ë©”ì‹œì§€ë¥¼ JSONìœ¼ë¡œ ì „ì†¡
                });
        
                const data = await response.json();
                
                // 3. "ë‹µë³€ ìƒì„± ì¤‘..." ë©”ì‹œì§€ë¥¼ ì‹¤ì œ ì‘ë‹µìœ¼ë¡œ êµì²´í•©ë‹ˆë‹¤.
                loadingMessageDiv.remove(); // ë¡œë”© ë©”ì‹œì§€ ì‚­ì œ
        
                let responseText = response.ok ? data.reply : `ì˜¤ë¥˜: ${data.error || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'}`;
                
                const assistantMessageDiv = document.createElement('div');
                assistantMessageDiv.className = 'message message-assistant';
                assistantMessageDiv.innerHTML = `
                  <div class="message-wrapper">
                    <div class="message-content">${responseText.replace(/\n/g, '<br>')}</div>
                    <button class="copy-btn" title="ë‚´ìš© ë³µì‚¬">ğŸ“‹</button>
                  </div>`;
                assistantMessageDiv.querySelector('.copy-btn').addEventListener('click', () => {
                    navigator.clipboard.writeText(responseText).catch(err => console.error('ë³µì‚¬ ì‹¤íŒ¨: ', err));
                });
                messagesContainer.appendChild(assistantMessageDiv);
        
            } catch (error) {
                // 4. ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜ ë“± fetch ìì²´ê°€ ì‹¤íŒ¨í–ˆì„ ê²½ìš°ì˜ ì˜ˆì™¸ ì²˜ë¦¬
                loadingMessageDiv.remove(); // ë¡œë”© ë©”ì‹œì§€ ì‚­ì œ
                const errorMessage = `ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜ ë˜ëŠ” ì„œë²„ ì—°ê²° ì‹¤íŒ¨: ${error.message}`;
                const errorMessageDiv = document.createElement('div');
                errorMessageDiv.className = 'message message-assistant';
                errorMessageDiv.innerHTML = `<div class="message-wrapper"><div class="message-content" style="color: red;">${errorMessage}</div></div>`;
                messagesContainer.appendChild(errorMessageDiv);
                console.error('Chat API Error:', error);
            } finally {
                // 5. ì‘ì—… ì™„ë£Œ í›„ ìŠ¤í¬ë¡¤ì„ í•­ìƒ ë§¨ ì•„ë˜ë¡œ ì´ë™
                messagesContainer.scrollTop = messagesContainer.scrollHeight;
            }
        };
        
        // íŒŒì¼ ì²˜ë¦¬ ë¡œì§
        const handleFiles = (files) => {
            if (uploadedFiles.length + files.length > 10) {
                showCustomAlert('íŒŒì¼ì€ ìµœëŒ€ 10ê°œê¹Œì§€ ì—…ë¡œë“œí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.');
                return;
            }
            for (const file of files) {
                uploadedFiles.push(file);
                const previewItem = document.createElement('div');
                previewItem.className = 'file-preview-item';
                previewItem.innerHTML = `<span>${file.name}</span><span class="remove-file-btn" title="íŒŒì¼ ì œê±°">Ã—</span>`;
                previewItem.querySelector('.remove-file-btn').onclick = () => {
                    uploadedFiles = uploadedFiles.filter(f => f !== file);
                    previewItem.remove();
                };
                filePreviewContainer.appendChild(previewItem);
            }
        };

        // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì—°ê²°
        sendButton.onclick = sendMessage;
        uploadButton.onclick = () => fileInput.click();
        fileInput.onchange = () => { handleFiles(fileInput.files); fileInput.value = ''; };
        messageInput.onkeydown = (e) => { if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); sendMessage(); } };
        messageInput.oninput = () => { messageInput.style.height = 'auto'; messageInput.style.height = `${messageInput.scrollHeight}px`; };
        
        const chatInputSection = chatPane.querySelector('.chat-input-section');
        chatInputSection.ondragover = (e) => { e.preventDefault(); chatInputSection.style.backgroundColor = '#e9ecef'; };
        chatInputSection.ondragleave = (e) => { e.preventDefault(); chatInputSection.style.backgroundColor = '#fff'; };
        chatInputSection.ondrop = (e) => { e.preventDefault(); chatInputSection.style.backgroundColor = '#fff'; if (e.dataTransfer.files) handleFiles(e.dataTransfer.files); };
        messageInput.onpaste = (e) => { if (e.clipboardData.files.length > 0) { e.preventDefault(); handleFiles(e.clipboardData.files); } };
        
        chatPane.dataset.chatInitialized = 'true';
    };

    // íƒ­ í™œì„±í™” ë¡œì§
    const activateTab = (tabToActivate) => {
        if (!tabToActivate) return;
        tabList.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        tabContentArea.querySelectorAll('.tab-content-pane').forEach(p => p.classList.remove('active'));
        tabToActivate.classList.add('active');
        const correspondingPane = tabContentArea.querySelector(`[data-tab-id="${tabToActivate.dataset.tabId}"]`);
        if (correspondingPane) {
            correspondingPane.classList.add('active');
            setupChatPane(correspondingPane);
        }
    };
    
    // ìƒˆ íƒ­ ì¶”ê°€ ë¡œì§
    addButton.addEventListener('click', () => {
        tabCounter++;
        const newTabId = `tab${tabCounter}`;
        const newTab = document.createElement('div');
        newTab.className = 'tab';
        newTab.dataset.tabId = newTabId;
        newTab.innerHTML = `<span>${newTabId}</span><span class="close-tab">Ã—</span>`;
        const newPane = document.createElement('div');
        newPane.className = 'tab-content-pane';
        newPane.dataset.tabId = newTabId;
        newPane.innerHTML = getAiChatHtml();
        tabList.appendChild(newTab);
        tabContentArea.appendChild(newPane);
        activateTab(newTab);
        tabList.scrollLeft = tabList.scrollWidth;
    });
    
    // íƒ­ í´ë¦­, ë‹«ê¸°, ì´ë¦„ ë°”ê¾¸ê¸°, ìŠ¤í¬ë¡¤ ë“± ë‚˜ë¨¸ì§€ íƒ­ ê´€ë¦¬ ë¡œì§
    tabList.addEventListener('click', (event) => {
        const target = event.target;
        if (target.classList.contains('close-tab')) {
            event.stopPropagation();
            const tabToRemove = target.closest('.tab');
            if (tabList.querySelectorAll('.tab').length === 1) { return showCustomAlert('ë§ˆì§€ë§‰ íƒ­ì€ ë‹«ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.'); }
            let nextTabToActivate = null;
            if (tabToRemove.classList.contains('active')) {
                nextTabToActivate = tabToRemove.previousElementSibling || tabToRemove.nextElementSibling;
            }
            const paneToRemove = tabContentArea.querySelector(`[data-tab-id="${tabToRemove.dataset.tabId}"]`);
            tabToRemove.remove();
            if(paneToRemove) paneToRemove.remove();
            if (nextTabToActivate) {
                activateTab(nextTabToActivate);
            }
            return;
        }
        const clickedTab = target.closest('.tab');
        if (clickedTab && !clickedTab.classList.contains('active')) {
            activateTab(clickedTab);
        }
    });

    tabList.addEventListener('dblclick', (event) => {
        const target = event.target;
        if (!target.matches('.tab > span:first-of-type')) { return; }
        const currentSpan = target;
        const currentName = currentSpan.textContent;
        const tempInput = document.createElement('input');
        tempInput.type = 'text';
        tempInput.value = currentName;
        tempInput.className = 'tab-edit-input';
        currentSpan.style.display = 'none';
        currentSpan.after(tempInput);
        tempInput.focus();
        tempInput.select();
        const finishEditing = () => {
            let newName = tempInput.value.trim();
            if (!newName) { currentSpan.textContent = currentName; }
            else {
                const otherTabSpans = [...tabList.querySelectorAll('.tab > span:first-of-type')].filter(span => span !== currentSpan);
                const existingNames = otherTabSpans.map(span => span.textContent);
                let finalName = newName;
                let counter = 2;
                while (existingNames.includes(finalName)) {
                    finalName = `${newName} (${counter})`;
                    counter++;
                }
                currentSpan.textContent = finalName;
            }
            tempInput.remove();
            currentSpan.style.display = '';
        };
        tempInput.addEventListener('blur', finishEditing);
        tempInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter') finishEditing();
        });
    });

    container.querySelectorAll('.tab-scroll-btn').forEach(button => {
        button.addEventListener('click', () => {
            const direction = parseInt(button.dataset.direction, 10);
            const scrollAmount = 200;
            tabList.scrollBy({ left: scrollAmount * direction, behavior: 'smooth' });
        });
    });
    
    activateTab(container.querySelector('.tab.active'));
}

// ==================================================================
// SECTION 4: í˜ì´ì§€ ì´ˆê¸°í™” ë° ê¸°ëŠ¥ë³„ ë‹´ë‹¹ í•¨ìˆ˜
// ==================================================================

/**
Â * ì—ë””í„° ê¸°ëŠ¥ì˜ ëª¨ë“  ì´ˆê¸°í™”ë¥¼ ë‹´ë‹¹í•˜ëŠ” í•¨ìˆ˜
Â */
function initEditorFeature() {
Â  Â  // ì—ë””í„° íƒ­ì´ í™œì„±í™”ë  ë•Œë§ˆë‹¤ ì‹¤í–‰ë  ë™ì‘ì„ ì •ì˜í•©ë‹ˆë‹¤.
Â  Â  const onEditorTabActivated = (activePane) => {
Â  Â  Â  Â  // ì „ì—­ ë³€ìˆ˜ë“¤ì´ í•­ìƒ í™œì„±í™”ëœ íƒ­ì˜ ìš”ì†Œë¥¼ ê°€ë¦¬í‚¤ë„ë¡ ì—…ë°ì´íŠ¸í•©ë‹ˆë‹¤.
Â  Â  Â  Â  mainTextArea = activePane.querySelector('#mainTextArea');
Â  Â  Â  Â  memoTextArea = activePane.querySelector('#memoTextArea');
Â  Â  Â  Â  docTitleInput = activePane.querySelector('#docTitle');
Â  Â  Â  Â  fontFamilySelect = activePane.querySelector('#fontFamily');
Â  Â  Â  Â  fontSizeInput = activePane.querySelector('#fontSize');
Â  Â  Â  Â  lineSpacingInput = activePane.querySelector('#lineSpacing');
Â  Â  Â  Â  paraSpacingAfterInput = activePane.querySelector('#paraSpacingAfter');
Â  Â  Â  Â  marginTopInput = activePane.querySelector('#marginTop');
Â  Â  Â  Â  marginBottomInput = activePane.querySelector('#marginBottom');
Â  Â  Â  Â  marginLeftInput = activePane.querySelector('#marginLeft');
Â  Â  Â  Â  marginRightInput = activePane.querySelector('#marginRight');
Â  Â  };

Â  Â  // ì—…ê·¸ë ˆì´ë“œëœ createTabComponentë¥¼ í˜¸ì¶œí•©ë‹ˆë‹¤.
Â  Â  createTabComponent(
Â  Â  Â  Â  '.Section2-3',Â 
Â  Â  Â  Â  'â–  Editor',Â 
Â  Â  Â  Â  getEditorHtml(),
Â  Â  Â  Â  onEditorTabActivated // íƒ­ í™œì„±í™” ì‹œ ì‹¤í–‰í•  ì½œë°± í•¨ìˆ˜ë¥¼ ì „ë‹¬í•©ë‹ˆë‹¤.
Â  Â  );
}

/**
 * AI ì±„íŒ… ê¸°ëŠ¥ì˜ ëª¨ë“  ì´ˆê¸°í™”ë¥¼ ë‹´ë‹¹í•˜ëŠ” í•¨ìˆ˜
 */
function initAiChatFeature() {
    initializeAiChatComponent('.Section2-2', 'â–  AI Chat');
}

/**
 * í”„ë¡¬í”„í„° ê¸°ëŠ¥ì˜ ì´ˆê¸°í™”ë¥¼ ë‹´ë‹¹í•˜ëŠ” í•¨ìˆ˜
 */
function initPrompterFeature() {
    createTabComponent('.Section2-1', 'â–  Prompter Selector', getPrompterListHtml(), null);
}

function initializeApp() {
    // DOMê³¼ GAPIê°€ ëª¨ë‘ ì¤€ë¹„ë˜ì—ˆì„ ë•Œë§Œ ì‹¤í–‰
    if (isDomReady && isGapiReady) {
        // 1. UI êµ¬ì¡° ìƒì„±
        initPrompterFeature();
        initAiChatFeature();
        initEditorFeature();
        loadingPopup = document.getElementById('loadingPopup');

        // 2. ë¡œê·¸ì¸ ì ˆì°¨ ì‹œì‘
        handleAuthClick();
    }
}    
    
// ==================================================================
// SECTION 5: DOM ë¡œë”© ì™„ë£Œ í›„ ì‹¤í–‰
// ==================================================================
document.addEventListener('DOMContentLoaded', () => {
    isDomReady = true; // DOM ì¤€ë¹„ ì™„ë£Œ ìƒíƒœë¡œ ë³€ê²½
    initializeApp();   // ì•± ì´ˆê¸°í™” ì‹œë„

    // ì´ë²¤íŠ¸ ìœ„ì„(Event Delegation)ìœ¼ë¡œ í´ë¦­ ì´ë²¤íŠ¸ ì²˜ë¦¬
    document.body.addEventListener('click', function(event) {
        if (event.target.closest('#google-sign-out-button')) {
            handleSignoutClick();
        }
        if (event.target.closest('.delete-all')) {
            clearTextArea();
        }
        if (event.target.closest('.create-doc')) {
            createWordClientSide();
        }
    });
    
    document.addEventListener('keydown', function(event) {
        if (event.altKey) {
            event.preventDefault();
            const keyMap = {
                '1': '{ì œëª©1.1}', '2': '{ì œëª©1.2}', '3': '{ì œëª©1.3}', '4': '{ì œëª©2.1}', '5': '{ì œëª©2.2}', '6': '{ì œëª©2.3}', '7': '{ì œëª©3.1}', '8': '{ì œëª©3.2}', '9': '{ì œëª©3.3}',
                'q': '{ì™¼ìª½}', 'w': '{ê°€ìš´ë°}', 'e': '{ì˜¤ë¥¸ìª½}', 'r': '{ì–‘ìª½}', 't': '{ê· ë“±}', 'y': '{10pt}', 'u': '{1ì¤„}',
                'i': '{ë“¤ì—¬ì“°ê¸°,1ë²ˆì¤„:0.5,2ë²ˆì¤„ì´í•˜:0.5}', 'o': '{ë“¤ì—¬ì“°ê¸°,1ë²ˆì¤„:1,2ë²ˆì¤„ì´í•˜:1}', 'p': '{ë“¤ì—¬ì“°ê¸°,1ë²ˆì¤„:0,2ë²ˆì¤„ì´í•˜:0.5}', '[': '{ë“¤ì—¬ì“°ê¸°,1ë²ˆì¤„:0.5,2ë²ˆì¤„ì´í•˜:1}',
                'a': '{ì§„í•˜ê²Œ}', 's': '{ë°‘ì¤„}', 'd': '{>>}', 'f': '{<<}', 'g': '{íƒ­}', 'h': '{ì¤„ë°”ê¿ˆ}', 'j': '{ë¬¸ë‹¨ë°”ê¿ˆ}', 'k': '{í˜ì´ì§€ë°”ê¿ˆ}',
                'z': '{í‘œì‹œì‘1,ê¸€ê¼´=??,í¬ê¸°=#}', 'x': '{í‘œì‹œì‘1,í…Œë‘ë¦¬ì—†ìŒ}', 'c': '{í‘œë1}', 'v': '{í‘œì‹œì‘2,ê¸€ê¼´=??,í¬ê¸°=#}', 'b': '{í‘œë2}',
                'n': '{ì œëª©í–‰}', 'm': '{íšŒìƒ‰}', ',': '{ë‚¨ìƒ‰}', '.': '{ê·¸ë¦¼:~}'
            };
            const syntax = keyMap[event.key.toLowerCase()];
            if (syntax && mainTextArea) { insertSyntax(syntax); }
        }
        if ((event.ctrlKey || event.metaKey) && event.key.toLowerCase() === 'z') {
            if (undoStack.length > 0) { event.preventDefault(); performUndo(); }
        }
        if ((event.ctrlKey || event.metaKey) && event.key.toLowerCase() === 's') { event.preventDefault(); if (mainTextArea) saveDraft(); }
        if (event.key === 'PageDown') { event.preventDefault(); if (mainTextArea) handleContextScroll(true); }
        if (event.key === 'PageUp') { event.preventDefault(); if (mainTextArea) handleContextScroll(false); }
    });
});
    
</script>

</body>
</html>
